<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Explorer Supabase | Neon + Floating ‚Ä¢‚Ä¢‚Ä¢</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg-dark:#0b0e16;
  --bg-card:#141829;
  --accent:#00ffc3;
  --accent2:#7a5cff; /* menu ungu */
  --text:#f5f5f5;
  --border:rgba(255,255,255,0.08);
}

/* basic */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:"Poppins",sans-serif;
  background:linear-gradient(145deg,#090d16,#101628);
  color:var(--text);
  display:flex;
  flex-direction:column;
}

/* header */
.header{
  height:56px;
  background:var(--bg-card);
  display:flex;align-items:center;padding:0 20px;
  color:var(--accent); font-weight:600; box-shadow:0 0 15px rgba(0,255,195,0.12);
  border-bottom:1px solid var(--border); text-shadow:0 0 6px rgba(0,255,195,0.2);
}

/* layout */
.container{display:flex;flex:1;overflow:hidden}
.sidebar{
  width:340px;background:var(--bg-card);border-right:1px solid var(--border);
  padding:14px;overflow:auto;box-shadow: inset 0 0 12px rgba(0,0,0,0.45);
}
.content{
  flex:1;padding:20px;background:var(--bg-dark);overflow:auto;
}

/* sidebar title & actions */
.sidebar h2{color:var(--accent2);font-size:1.05rem;margin-bottom:10px;text-shadow:0 0 8px rgba(122,92,255,0.25)}
.root-actions{display:flex;gap:8px;margin-bottom:12px}
.btn{
  background:var(--accent);color:var(--bg-card);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;
  box-shadow:0 0 10px rgba(0,255,195,0.12);font-weight:600;
}
.btn.secondary{background:var(--accent2);color:var(--bg-card)}
.btn:active{transform:translateY(1px)}

/* tree */
.folder-list{list-style:none;padding-left:6px}
.folder-li{padding:4px 6px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.folder-button{
  display:flex;align-items:center;gap:8px;flex:1;cursor:pointer;padding:6px;border-radius:6px;
}
.folder-button:hover{background:rgba(255,255,255,0.03)}
.folder-button .toggle{color:var(--accent);user-select:none}
.folder-button .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.folder-button.selected{background:var(--accent);color:var(--bg-card);font-weight:600;box-shadow:0 0 10px rgba(0,255,195,0.18)}

/* file item displayed under folder */
.file-item{padding:6px 12px;margin-left:28px;border-radius:6px;cursor:pointer;color:var(--text);opacity:0.95}
.file-item:hover{color:var(--accent2);background:rgba(255,255,255,0.02)}

/* small three-dot trigger (visible on hover) */
.item-controls{
  opacity:0;transition:opacity .15s;display:flex;align-items:center;
}
.folder-li:hover > .item-controls{opacity:1}
.dot-btn{
  background:transparent;border:none;color:var(--accent2);font-weight:700;cursor:pointer;padding:4px 6px;border-radius:6px;
}
.dot-btn:hover{transform:scale(1.05);}

/* floating menu (fixed to right) */
.floating-menu{
  position:fixed;
  right:18px;
  bottom:80px;
  background:linear-gradient(180deg, rgba(18,10,30,0.86), rgba(20,18,30,0.86));
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;
  min-width:180px;
  box-shadow:0 8px 30px rgba(10,6,30,0.6);
  padding:8px; z-index:9999;
  transform-origin:100% 100%;
  display:none;
  backdrop-filter: blur(6px);
}

/* animation: fade+scale */
.floating-menu.show{
  display:block;
  animation: popIn .14s cubic-bezier(.2,.9,.26,1);
}
@keyframes popIn{
  0%{opacity:0;transform:scale(.86) translateY(6px)}
  100%{opacity:1;transform:scale(1) translateY(0)}
}

/* menu items */
.floating-menu button{
  display:flex;align-items:center;gap:8px;width:100%;
  background:transparent;border:none;color:var(--text);padding:10px;border-radius:8px;cursor:pointer;text-align:left;
}
.floating-menu button:hover{background:linear-gradient(90deg, rgba(122,92,255,0.06), rgba(0,255,195,0.02));color:var(--accent)}
.sep{height:1px;background:rgba(255,255,255,0.03);margin:6px 0;border-radius:2px}

/* content panel */
.content h3{color:var(--accent);text-shadow:0 0 8px rgba(0,255,195,0.2)}
.file-editor{
  background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;min-height:260px;
  margin-top:12px;color:var(--text);font-family:Consolas,monospace;white-space:pre-wrap;box-shadow:inset 0 0 10px rgba(0,0,0,0.4)
}
.save-row{margin-top:12px;display:flex;gap:10px;align-items:center}
.small-note{color:rgba(245,245,245,0.55);font-size:0.9rem}
</style>
</head>
<body>
  <div class="header">‚òÅÔ∏è Supabase Explorer ‚Äî Neon (Floating ‚Ä¢‚Ä¢‚Ä¢)</div>
  <div class="container">
    <nav class="sidebar">
      <h2>üóÇÔ∏è Struktur Folder</h2>
      <div class="root-actions">
        <button class="btn" id="addRootFolderBtn">+ Folder root</button>
        <button class="btn secondary" id="addRootFileBtn">+ File root</button>
      </div>
      <ul id="folderTree" class="folder-list">Memuat...</ul>
    </nav>

    <main class="content">
      <h3 id="content-title">Pilih file</h3>
      <p class="small-note">Klik folder untuk buka / tutup. Klik nama file untuk lihat & edit di panel kanan.</p>
      <div id="fileEditor" class="file-editor" contenteditable="true">(Pilih file untuk menampilkan isinya)</div>
      <div class="save-row">
        <button class="btn" id="saveBtn">üíæ Simpan</button>
        <span id="saveStatus" class="small-note"></span>
      </div>
    </main>
  </div>

  <!-- floating menu (fixed on right-bottom) -->
  <div id="floatingMenu" class="floating-menu" role="menu" aria-hidden="true">
    <!-- Menu content populated dynamically -->
  </div>

<script>
/* ---------- Supabase init ---------- */
const SUPABASE_URL = 'https://zawtfjszvkuudawrilqg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphd3RmanN6dmt1dWRhd3JpbHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTk2NzMsImV4cCI6MjA3NDk5NTY3M30.CGYz4-QnYb3Hu9p3fV0XoG5J8oicqZsji-YJf2UItQ8';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- state ---------- */
let currentMenuTarget = null; // { id: uuid, type: 'folder'|'file', domEl: element }
let selectedFileId = null;

/* ---------- helpers to build DOM items ---------- */
function createFolderLi(folder){
  const li = document.createElement('li');
  li.className = 'folder-li';
  li.dataset.id = folder.id;
  li.dataset.type = 'folder';

  // left: clickable folder button
  const btn = document.createElement('div');
  btn.className = 'folder-button';
  btn.innerHTML = `<span class="toggle">‚ñ∂</span><span class="name">${escapeHtml(folder.name)}</span>`;
  btn.onclick = (e)=> { e.stopPropagation(); toggleFolder(btn, folder.id); };

  // right: floating menu trigger (‚Ä¢‚Ä¢‚Ä¢)
  const controls = document.createElement('div');
  controls.className = 'item-controls';
  const dot = document.createElement('button');
  dot.className = 'dot-btn';
  dot.innerText = '‚Ä¢‚Ä¢‚Ä¢';
  dot.onclick = (ev)=> { ev.stopPropagation(); showFloatingMenu(folder.id, 'folder', li); };
  controls.appendChild(dot);

  li.appendChild(btn);
  li.appendChild(controls);

  // child container (collapsed by default)
  const ul = document.createElement('ul');
  ul.className = 'folder-list hidden';
  ul.dataset.loaded = ''; // empty => not loaded
  li.appendChild(ul);

  return li;
}

function createFileLi(file){
  const li = document.createElement('li');
  li.className = 'file-item';
  li.dataset.id = file.id;
  li.dataset.type = 'file';

  // left: file name clickable
  const nameDiv = document.createElement('div');
  nameDiv.style.flex = '1';
  nameDiv.textContent = `üìÑ ${file.name}`;
  nameDiv.onclick = (e)=> { e.stopPropagation(); openFile(file); };

  // right: dot menu
  const controls = document.createElement('div');
  controls.className = 'item-controls';
  const dot = document.createElement('button');
  dot.className = 'dot-btn';
  dot.innerText = '‚Ä¢‚Ä¢‚Ä¢';
  dot.onclick = (ev)=> { ev.stopPropagation(); showFloatingMenu(file.id, 'file', li); };
  controls.appendChild(dot);

  li.appendChild(nameDiv);
  li.appendChild(controls);

  return li;
}

/* ---------- escape helper ---------- */
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]);
}

/* ---------- render root list ---------- */
async function loadRootFolders(){
  const root = document.getElementById('folderTree');
  root.innerHTML = 'Memuat...';
  const { data, error } = await supabase.from('folder_items')
    .select('*')
    .is('parent_id', null)
    .eq('type','folder')
    .order('name', { ascending: true });

  if(error){ root.innerHTML = '<li style="color:#ff5c5c">Gagal memuat</li>'; console.error(error); return; }
  root.innerHTML = '';
  data.forEach(f=> root.appendChild(createFolderLi(f)));
}

/* ---------- toggle folder (lazy load + collapse) ---------- */
async function toggleFolder(btnEl, folderId){
  const li = btnEl.parentElement;
  const ul = li.querySelector('ul.folder-list');
  const icon = btnEl.querySelector('.toggle');

  // if open -> close
  if(!ul.classList.contains('hidden')){
    ul.classList.add('hidden');
    icon.textContent = '‚ñ∂';
    return;
  }

  // open
  icon.textContent = '‚ñº';
  ul.classList.remove('hidden');

  // if already loaded before, do not fetch again
  if(ul.dataset.loaded === 'true') return;

  // show loading
  ul.innerHTML = '<li style="opacity:.6;padding:6px 8px;">Memuat...</li>';

  // fetch children (both folders and files)
  const { data, error } = await supabase.from('folder_items')
    .select('*')
    .eq('parent_id', folderId)
    .order('type', { ascending: false }) /* folders first? we'll sort below */

  if(error){ ul.innerHTML = '<li style="color:#ff7777;padding:6px 8px;">Gagal memuat</li>'; console.error(error); return; }

  // separate folders and files and sort by name
  const folders = data.filter(i=>i.type==='folder').sort((a,b)=>a.name.localeCompare(b.name));
  const files = data.filter(i=>i.type==='file').sort((a,b)=>a.name.localeCompare(b.name));

  ul.innerHTML = '';
  if(folders.length===0 && files.length===0){
    ul.innerHTML = '<li style="opacity:.6;padding:6px 8px;">(Kosong)</li>';
  } else {
    folders.forEach(f=> ul.appendChild(createFolderLi(f)));
    files.forEach(f=> ul.appendChild(createFileLi(f)));
  }
  ul.dataset.loaded = 'true';
}

/* ---------- open file to editor (right panel) ---------- */
async function openFile(file){
  document.getElementById('content-title').textContent = `File: ${file.name}`;
  document.getElementById('content-type').textContent = 'File';
  const editor = document.getElementById('fileEditor');
  editor.textContent = 'Memuat...';
  const { data, error } = await supabase.from('folder_items').select('content').eq('id', file.id).single();
  if(error){ editor.textContent = '(Gagal memuat)'; console.error(error); return; }
  editor.textContent = data?.content ?? '';
  selectedFileId = file.id;
}

/* ---------- save editor content ---------- */
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const status = document.getElementById('saveStatus');
  const editor = document.getElementById('fileEditor');
  if(!selectedFileId){ alert('Pilih file dulu.'); return; }
  status.textContent = 'Menyimpan...';
  const { error } = await supabase.from('folder_items').update({ content: editor.textContent }).eq('id', selectedFileId);
  status.textContent = error ? '‚ùå Gagal' : '‚úÖ Tersimpan';
  setTimeout(()=> status.textContent = '', 1800);
});

/* ---------- floating menu UI ---------- */
const floatingMenu = document.getElementById('floatingMenu');

function buildMenuFor(target){
  // target: { id, type, domEl }
  const t = target;
  floatingMenu.innerHTML = ''; // clear

  // helper to create menu button
  const mkBtn = (label, emoji, onclick)=> {
    const b = document.createElement('button');
    b.innerHTML = `<span>${emoji}</span><span>${label}</span>`;
    b.onclick = async (e)=>{ e.stopPropagation(); hideMenu(); await onclick(); };
    return b;
  };

  if(t.type === 'folder'){
    floatingMenu.appendChild(mkBtn('Tambah Folder di sini', 'üìÅ', async ()=> addChild(t.id, 'folder')));
    floatingMenu.appendChild(mkBtn('Tambah File di sini', 'üìÑ', async ()=> addChild(t.id, 'file')));
    floatingMenu.appendChild(document.createElement('div')).className='sep';
    floatingMenu.appendChild(mkBtn('Ubah Nama Folder', '‚úèÔ∏è', async ()=> renameItem(t.id)));
    floatingMenu.appendChild(mkBtn('Hapus Folder (dan isinya)', 'üóëÔ∏è', async ()=> deleteItem(t.id, 'folder')));
  } else {
    floatingMenu.appendChild(mkBtn('Ubah Nama File', '‚úèÔ∏è', async ()=> renameItem(t.id)));
    floatingMenu.appendChild(mkBtn('Hapus File', 'üóëÔ∏è', async ()=> deleteItem(t.id, 'file')));
  }
}

/* show floating menu (floating to right, animated) */
function showFloatingMenu(id, type, domEl){
  currentMenuTarget = { id, type, domEl };
  buildMenuFor(currentMenuTarget);
  floatingMenu.classList.add('show');
  floatingMenu.setAttribute('aria-hidden','false');
}

/* hide */
function hideMenu(){
  floatingMenu.classList.remove('show');
  floatingMenu.setAttribute('aria-hidden','true');
  currentMenuTarget = null;
}

/* hide when clicking outside */
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.floating-menu') && !e.target.closest('.dot-btn')) {
    hideMenu();
  }
});

/* ---------- CRUD actions ---------- */

/* add child (folder or file) under parentId */
async function addChild(parentId, type){
  const name = prompt(`Nama ${type==='folder'?'Folder':'File'} baru:`,'baru');
  if(!name) return;
  const initial = type==='file' ? 'Tulis isi file...' : null;
  const { data, error } = await supabase.from('folder_items').insert({
    name: name.trim(),
    type,
    parent_id: parentId,
    content: initial
  }).select().single();

  if(error){ alert('Gagal menambah: '+error.message); console.error(error); return; }

  // refresh the parent UL: find parent li and reset dataset.loaded so toggleFolder will reload
  const parentLi = document.querySelector(`li.folder-li[data-id="${parentId}"]`);
  if(parentLi){
    const ul = parentLi.querySelector('ul.folder-list');
    if(ul){
      ul.dataset.loaded = ''; // mark not loaded
      // if currently open, collapse then re-open to refresh
      const btn = parentLi.querySelector('.folder-button');
      if(ul.classList.contains('hidden')){
        // closed: leave closed (no immediate UI change)
      } else {
        // open: force reload
        // close then open to re-fetch (gives visual refresh)
        ul.classList.add('hidden');
        btn.querySelector('.toggle').textContent = '‚ñ∂';
        // tiny delay for UX, then re-open (and thus reload)
        setTimeout(()=> toggleFolder(btn, parentId), 120);
      }
    }
  } else {
    // if parent is root null, reload root list
    await loadRootFolders();
  }
}

/* rename item (folder or file) */
async function renameItem(id){
  // fetch existing name
  const { data, error } = await supabase.from('folder_items').select('name,type').eq('id', id).single();
  if(error){ alert('Gagal mengambil item.'); console.error(error); return; }
  const newName = prompt('Nama baru:', data.name);
  if(!newName || newName.trim()===data.name) return;
  const { error: err2 } = await supabase.from('folder_items').update({ name: newName.trim() }).eq('id', id);
  if(err2){ alert('Gagal mengubah nama'); console.error(err2); return; }

  // update DOM quickly
  const el = document.querySelector(`[data-id="${id}"]`);
  if(el){
    // folder => update .name; file => textContent
    if(el.classList.contains('folder-li')){
      const nameSpan = el.querySelector('.name');
      if(nameSpan) nameSpan.textContent = newName;
    } else {
      // file-item
      el.querySelector('div')?.textContent = `üìÑ ${newName}`;
    }
  }
}

/* delete item (if folder, cascade in DB by FK) */
async function deleteItem(id, typeOverride){
  if(!confirm('Yakin akan menghapus?')) return;
  const { error } = await supabase.from('folder_items').delete().eq('id', id);
  if(error){ alert('Gagal hapus'); console.error(error); return; }

  // remove from DOM
  const el = document.querySelector(`[data-id="${id}"]`);
  if(el){
    const parentUl = el.parentElement;
    el.remove();
    // if parent becomes empty, show (Kosong)
    if(parentUl && parentUl.classList.contains('folder-list') && parentUl.children.length === 0){
      parentUl.innerHTML = '<li style="opacity:.6;padding:6px 8px">(Kosong)</li>';
    }
  }

  // if deleted item was currently selected file, clear editor
  if(selectedFileId === id){
    selectedFileId = null;
    document.getElementById('fileEditor').textContent = '(Pilih file lain)';
    document.getElementById('content-title').textContent = 'Pilih file';
    document.getElementById('content-type').textContent = '';
  }
}

/* ---------- add root folder & file ---------- */
document.getElementById('addRootFolderBtn').addEventListener('click', async ()=>{
  const name = prompt('Nama folder root baru:','Folder Baru');
  if(!name) return;
  const { error } = await supabase.from('folder_items').insert({ name: name.trim(), type: 'folder', parent_id: null }).select();
  if(error){ alert('Gagal menambah root folder'); console.error(error); return; }
  await loadRootFolders();
});

document.getElementById('addRootFileBtn').addEventListener('click', async ()=>{
  const name = prompt('Nama file root baru:','file_baru.txt');
  if(!name) return;
  const { error } = await supabase.from('folder_items').insert({ name: name.trim(), type: 'file', parent_id: null, content: '' }).select();
  if(error){ alert('Gagal menambah root file'); console.error(error); return; }
  // place file at root (we don't render files in root by default as tree expects folders, so reload root to reflect)
  await loadRootFolders();
});

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadRootFolders();
});
</script>
</body>
</html>

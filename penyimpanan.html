<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Explorer | Neon Dark</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Consolas:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- 1. VARIABEL WARNA NEON DARK --- */
        :root {
            --bg-dark: #0b0e16;
            --bg-card: #141829;
            --accent: #00ffc3; /* Neon Cyan */
            --accent2: #7a5cff; /* Neon Purple */
            --text: #f5f5f5;
            --subtext: #b0b0b0;
            --border: rgba(255,255,255,0.15); /* Border sedikit lebih terang */
            --hover-color: #1a223f; 
            --select-color: rgba(0, 255, 195, 0.2); 
            --danger-color: #ff6666; /* Merah sedikit lebih lembut */
            --success-color: #00e6a3;
            --header-height: 55px; /* Tinggi header ditingkatkan */
            --sidebar-width: 300px;
        }

        /* --- 2. RESET DAN LAYOUT UTAMA (DARK) --- */
        
        * { box-sizing:border-box; margin:0; padding:0; }

        body { 
            font-family:'Poppins', sans-serif;
            background:linear-gradient(145deg,#070a13,#101628); /* Darker Gradient */
            color:var(--text); 
            height: 100vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Mencegah scroll body */
        }

        /* Header (Global Top Bar) */
        .header {
            height: var(--header-height);
            background-color: var(--accent2); 
            color: var(--text);
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 1.3em; /* Lebih besar */
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(122, 92, 255, 0.4); /* Shadow lebih kuat */
            flex-shrink: 0;
            z-index: 10;
        }

        .file-explorer { 
            display: flex; 
            flex-grow: 1; 
            min-height: 0; /* Penting untuk flex layout */
        }

        /* --- 3. SIDEBAR (EXPLORER TREE) --- */

        .sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--bg-card); 
            border-right: 1px solid var(--border); 
            padding: 20px; /* Padding lebih besar */
            overflow-y: auto; 
            flex-shrink: 0; 
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-out; /* Transisi untuk mobile */
        }
        
        .sidebar h2 {
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0,255,195,0.4); /* Garis bawah lebih tegas */
            font-size: 1.3em;
            font-weight: 700;
            color: var(--accent); 
            text-shadow: 0 0 10px rgba(0,255,195,0.6);
        }

        .action-bar { 
            margin-bottom: 20px; 
            display: flex;
            gap: 10px; /* Jarak tombol lebih besar */
            flex-wrap: wrap;
        }
        .action-bar button { 
            background-color: var(--accent); 
            color: var(--bg-dark); 
            border: none; 
            padding: 8px 15px; /* Tombol lebih besar */
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0,255,195,0.5);
            flex-grow: 1;
        }
        .action-bar button:hover { 
            background-color: #00e6a3; 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,195,0.8);
        }

        /* --- 4. LIST FILE/FOLDER STYLING (DARK) --- */
        
        .folder-list { 
            list-style: none; 
            padding-left: 0; 
            margin: 0; 
            user-select: none;
            line-height: 1.5;
        }
        
        .folder-list > li > ul.folder-list { padding-left: 20px; display: none; }
        .folder-list li.expanded > ul.folder-list { display: block; }
        
        .item-header {
            display: flex; 
            align-items: center;
            justify-content: space-between; 
            padding: 6px 10px; 
            cursor: pointer;
            border-radius: 6px; /* Sudut lebih membulat */
            transition: background-color 0.2s, border 0.2s;
        }

        .folder-list li:hover > .item-header { background-color: var(--hover-color); }
        .folder-list li.selected > .item-header { 
            background-color: var(--select-color); 
            font-weight: 600; 
            border: 1px solid var(--accent); 
            box-shadow: 0 0 5px rgba(0,255,195,0.5) inset;
            padding: 5px 9px;
        }
        
        /* Ikon Folder/File - BASE STYLE */
        .item-header .icon {
            margin-right: 8px; 
            vertical-align: middle; 
            font-size: 16px; 
            width: 18px;
            text-align: center;
        }
        .folder-list li.file > .item-header .icon { color: var(--subtext); font-size: 14px; }
        .folder-list li.folder > .item-header .icon { color: var(--accent2); } 
        
        .folder-list li.folder > .item-header .item-name::before {
            content: '▶';
            font-size: 9px;
            margin-right: 5px;
            color: var(--accent); 
            transition: transform 0.2s;
            display: inline-block;
            font-family: Arial, sans-serif;
        }
        .folder-list li.folder.expanded > .item-header .item-name::before {
            content: '▼';
        }
        
        .item-name {
            flex-grow: 1; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 5px; 
            display: flex;
            align-items: center;
        }
        
        /* Style untuk input edit nama */
        .item-edit-input {
            flex-grow: 1;
            padding: 4px 6px;
            margin-right: -4px; 
            border: 2px solid var(--accent);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--bg-dark);
            color: var(--text);
        }

        /* --- KONTROL ELIPSIS (NEON) --- */

        .controls {
            position: relative;
            flex-shrink: 0;
            padding-left: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        /* Selalu tampilkan kontrol di HP, atau saat menu terbuka */
        .folder-list li:hover > .item-header .controls,
        .controls.active { opacity: 1; } 
        
        .ellipsis-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            font-weight: bold;
            font-size: 1.2em;
            padding: 2px 5px;
            border-radius: 3px;
            transition: color 0.2s, background-color 0.2s;
        }
        .ellipsis-button:hover {
            background-color: var(--hover-color);
            color: var(--accent);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%; 
            right: 0; 
            background-color: var(--bg-card);
            border: 1px solid var(--accent); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5), 0 0 10px rgba(0,255,195,0.4);
            border-radius: 6px;
            z-index: 1000;
            min-width: 180px;
            padding: 5px 0;
            display: none;
        }

        .dropdown-menu.visible { display: block; }

        .dropdown-menu button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text);
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .dropdown-menu button:hover {
            background-color: var(--hover-color);
            color: var(--accent);
        }
        .dropdown-menu button.delete-btn { color: var(--danger-color); }
        .dropdown-menu button.delete-btn:hover {
            background-color: rgba(255, 102, 102, 0.2);
            color: var(--danger-color);
        }

        /* --- 5. CONTENT PANEL (EDITOR) --- */

        .content-panel { 
            flex-grow: 1; 
            background-color: var(--bg-dark); 
            padding: 25px; /* Padding lebih besar */
            overflow-y: auto; 
            position: relative; 
        }
        
        .content-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align-items center untuk header */
            margin-bottom: 10px;
        }

        .content-panel h3 {
            color: var(--accent);
            text-shadow: 0 0 8px rgba(0,255,195,0.5);
            font-size: 1.5em; /* Lebih besar */
            margin: 0; 
            flex-shrink: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #download-button {
            background-color: var(--accent2); 
            color: var(--text); 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(122, 92, 255, 0.5);
            margin-left: 15px;
            flex-shrink: 0;
            display: none; 
        }
        #download-button:hover { 
            background-color: #6a49e0; 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(122, 92, 255, 0.7);
        }
        
        .file-content { 
            white-space: pre-wrap; 
            background-color: var(--bg-card); 
            padding: 20px; 
            border-radius: 8px; 
            min-height: 400px; 
            font-family: 'Consolas', monospace; 
            font-size: 0.95em; 
            border: 1px solid var(--border);
            height: calc(100vh - var(--header-height) - 150px); /* Ketinggian dinamis */
            overflow: auto; 
            color: var(--text);
            transition: border-color 0.3s, box-shadow 0.3s;
            line-height: 1.6;
        }
        
        #file-editor[contenteditable="true"] {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 195, 0.6);
        }
        
        #save-status {
            color: var(--success-color);
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 230, 163, 0.5);
            margin-top: 10px;
            display: block;
        }

        /* --- 6. RESPONSIVITAS (MOBILE) --- */

        @media (max-width: 900px) {
            .file-explorer {
                position: relative; /* Container untuk sidebar absolute */
            }

            .sidebar {
                position: absolute; /* Sidebar menjadi overlay */
                left: 0;
                top: 0;
                height: 100%;
                width: 75%; /* Lebih lebar di mobile */
                z-index: 50;
                transform: translateX(-100%); /* Sembunyikan default */
                box-shadow: 5px 0 15px rgba(0,0,0,0.8);
            }

            .sidebar.visible {
                transform: translateX(0);
            }
            
            .content-panel {
                padding: 15px; /* Padding lebih kecil di mobile */
                width: 100%;
            }

            .content-header-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .content-panel h3 {
                font-size: 1.3em;
            }

            .action-bar {
                flex-wrap: nowrap;
                overflow-x: auto; /* Scroll horizontal untuk tombol */
                padding-bottom: 5px;
                border-bottom: 1px solid var(--border);
            }
            .action-bar button {
                flex-shrink: 0;
                padding: 6px 10px;
                font-size: 0.9em;
            }
            
            .file-content {
                min-height: 300px;
                height: calc(100vh - var(--header-height) - 130px);
            }
        }
        
        /* Tombol Toggle Sidebar (Hanya di Mobile) */
        .sidebar-toggle {
            display: none;
            position: absolute;
            left: 10px;
            top: 10px;
            background-color: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 51;
            box-shadow: 0 0 10px rgba(0,255,195,0.5);
        }
        @media (max-width: 900px) {
            .sidebar-toggle {
                display: block;
            }
            .header {
                padding-left: 60px; /* Ruang untuk tombol toggle */
            }
        }
    </style>
</head>
<body>

<div class="header">
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">☰</button>
    <span style="margin-right: 10px;">⚡</span> File Explorer
</div>

<div class="file-explorer">
    
    <div class="sidebar" id="sidebar">
        <h2><span style="margin-right: 8px;">🗂️</span> Daftar Folder</h2>
        
        <div class="action-bar">
            <button onclick="addNewItem(null, 'folder'); toggleMenu(null);">➕ Folder</button>
            <button onclick="addNewItem(null, 'file'); toggleMenu(null);">➕ File</button>
        </div>

        <ul class="folder-list" id="root-list">
            <li style="text-align: center;">Memuat data...</li>
        </ul>
    </div>
    
    <div class="content-panel">
        <div class="content-header-row">
             <h3 id="content-title">Pilih File untuk Melihat Konten</h3>
             <button id="download-button" onclick="downloadFileContent()"><span style="margin-right: 5px;">⬇️</span> Unduh</button>
        </div>
        <p style="color: var(--subtext); font-size: 0.9em;">Tipe: <span id="content-type"></span></p>
        
        <div class="file-content" id="file-editor" contenteditable="false">
            Selamat datang di File Explorer!
            
            Gunakan sidebar di kiri untuk:
            1. Menambah folder/file baru.
            2. Mengedit/menghapus item.
            3. Memilih file untuk mengedit konten di sini.

            *Ini adalah editor konten. Perubahan akan disimpan secara otomatis.*
        </div>
        
        <span id="save-status"></span>
    </div>

</div>

<script>
    // ----------------------------------------------------------------------
    // --- 1. INISIALISASI SUPABASE & GLOBAL STATE ---
    // ----------------------------------------------------------------------
    
    const SUPABASE_URL = 'https://zawtfjszvkuudawrilqg.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphd3RmanN6dmt1dWRhd3JpbHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTk2NzMsImV4cCI6MjA3NDk5NTY3M30.CGYz4-QnYb3Hu9p3fV0XoG5J8oicqZsji-YJf2UItQ8';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let itemCounter = 1; 
    let selectedItemId = null; 
    let selectedItemName = null; 
    let allItemsData = []; 

    let autosaveListener = null;

    // ----------------------------------------------------------------------
    // --- 2. FUNGSI UTILITY & RESPONSIVITAS ---
    // ----------------------------------------------------------------------

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        
        switch (ext) {
            case 'js': case 'ts': case 'mjs': return '📜'; // Script/JS
            case 'html': case 'htm': return '🌐'; // Web/HTML
            case 'css': return '🎨'; // Style/CSS
            case 'json': case 'yaml': case 'yml': return '⚙️'; // Config/Data
            case 'md': case 'markdown': return '📝'; // Markdown
            case 'txt': case 'log': return '📄'; // Text
            case 'jpg': case 'jpeg': case 'png': case 'gif': case 'svg': return '🖼️'; // Gambar
            case 'mp3': case 'wav': case 'ogg': return '🎧'; // Audio
            case 'mp4': case 'mov': case 'webm': return '📹'; // Video
            default: return '❓'; // Default atau file tidak dikenal
        }
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }
    
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('visible');
        // Tutup menu dropdown jika sidebar dibuka/ditutup
        toggleMenu(null);
    };


    // ----------------------------------------------------------------------
    // --- 3. FUNGSI AUTOSAVE & UNDUH ---
    // ----------------------------------------------------------------------
    
    const editor = document.getElementById('file-editor');
    const saveStatus = document.getElementById('save-status');
    
    const autoSaveFileContent = async () => {
        const itemUUID = selectedItemId;
        const newContent = editor.textContent;

        if (!itemUUID) return; 

        saveStatus.textContent = 'Menyimpan...';
        saveStatus.style.color = '#fff';

        const { error } = await supabase
            .from('folder_items')
            .update({ content: newContent })
            .eq('id', itemUUID);

        if (error) {
            saveStatus.textContent = `Gagal menyimpan: ${error.message}`;
            saveStatus.style.color = 'var(--danger-color)';
            console.error("Error saving content:", error);
        } else {
            // Update cache agar konten baru langsung tersedia
            const cachedItem = allItemsData.find(i => i.id.toString() === itemUUID);
            if(cachedItem) cachedItem.content = newContent;

            saveStatus.textContent = 'Tersimpan!';
            saveStatus.style.color = 'var(--success-color)';
            setTimeout(() => { 
                if (editor.contentEditable === 'true' && selectedItemId === itemUUID) {
                    saveStatus.textContent = 'Menunggu perubahan...';
                    saveStatus.style.color = 'var(--subtext)';
                }
            }, 3000);
        }
    };

    const debouncedAutoSave = debounce(autoSaveFileContent, 500);
    
    window.downloadFileContent = function() {
        if (!selectedItemId || !selectedItemName || editor.contentEditable === 'false') {
            alert("Tidak ada file yang dapat diunduh.");
            return;
        }

        const content = editor.textContent;
        const filename = selectedItemName;

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); 
    };
    
    // ----------------------------------------------------------------------
    // --- 4. FUNGSI RENDER & INTERAKSI LIST ---
    // ----------------------------------------------------------------------

    function createItemElement(itemData) {
        const itemId = `item-${itemData.id}`;
        const itemClass = itemData.type === 'folder' ? 'folder' : `file`; 
        const li = document.createElement('li');
        li.className = itemClass;
        li.id = itemId;
        const isFolder = itemData.type === 'folder';

        let itemIcon = isFolder ? '📁' : getFileIcon(itemData.name);

        const folderActions = isFolder 
            ? `
                <button onclick="addNewItem('${itemId}', 'folder'); toggleMenu('${itemId}');">➕ Tambah Folder</button>
                <button onclick="addNewItem('${itemId}', 'file'); toggleMenu('${itemId}');">➕ Tambah File</button>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 5px 0;">
              `
            : '';

        li.innerHTML = `
            <div class="item-header" onclick="selectItem('${itemId}')">
                <span class="icon">${itemIcon}</span>
                <span class="item-name">${itemData.name}</span>
                <div class="controls" id="controls-${itemId}">
                    <button class="ellipsis-button" onclick="event.stopPropagation(); toggleMenu('${itemId}')">•••</button>
                    <div class="dropdown-menu" id="menu-${itemId}">
                        ${folderActions}
                        <button onclick="editItemName('${itemId}'); toggleMenu('${itemId}');">✏️ Edit Nama</button>
                        <button class="delete-btn" onclick="deleteItem('${itemId}'); toggleMenu('${itemId}');">🗑️ Hapus</button>
                    </div>
                </div>
            </div>
            ${isFolder ? '<ul class="folder-list"></ul>' : ''}
        `;
        return li;
    }
    
    function buildTree(items) {
        const rootItems = [];
        const itemsMap = {};
        items.forEach(item => { 
             const idStr = item.id.toString(); 
             const parentIdStr = item.parent_id ? item.parent_id.toString() : null;
             // Pastikan konten di-cache
             itemsMap[idStr] = {...item, id: idStr, parent_id: parentIdStr, children: []}; 
        });
        
        Object.values(itemsMap).forEach(item => {
            if (item.parent_id === null) {
                rootItems.push(item);
            } else if (itemsMap[item.parent_id]) {
                itemsMap[item.parent_id].children.push(item);
            }
        });
        return rootItems;
    }

    function renderTree(items, ulElement) {
        items.sort((a, b) => (b.type === 'folder') - (a.type === 'folder') || a.name.localeCompare(b.name));
        
        items.forEach(item => {
            const li = createItemElement(item);
            ulElement.appendChild(li);
            
            if (item.type === 'folder' && item.children.length > 0) {
                const newUl = document.createElement('ul');
                newUl.className = 'folder-list';
                li.appendChild(newUl);
                renderTree(item.children, newUl);
            }
        });
    }

    window.toggleMenu = function(itemId) {
        const menu = itemId ? document.getElementById(`menu-${itemId}`) : null;
        
        document.querySelectorAll('.dropdown-menu.visible').forEach(openMenu => {
            if (!itemId || openMenu.id !== `menu-${itemId}`) {
                openMenu.classList.remove('visible');
                openMenu.parentNode.classList.remove('active');
            }
        });

        if (menu) {
            const controls = document.getElementById(`controls-${itemId}`);
            menu.classList.toggle('visible');
            controls.classList.toggle('active');
        }
    };

    document.addEventListener('click', function(event) {
        let isInsideMenu = event.target.closest('.dropdown-menu, .ellipsis-button');
        if (!isInsideMenu) {
            toggleMenu(null);
        }
    });


    window.fetchAndRenderItems = async function() {
        const rootList = document.getElementById('root-list');
        rootList.innerHTML = '<li style="text-align: center; color: var(--subtext);">Memuat data...</li>';

        // Ambil semua data dengan konten untuk cache
        const { data, error } = await supabase
            .from('folder_items')
            .select('*'); 

        if (error) {
            console.error("Gagal mengambil data:", error);
            rootList.innerHTML = `<li style="color: var(--danger-color); text-align: left;">ERROR: Gagal memuat data.</li>`;
            return;
        }

        allItemsData = data; 
        rootList.innerHTML = '';
        const tree = buildTree(data);
        renderTree(tree, rootList);
    }
    
    window.addNewItem = async function(parentId, type) {
        let name;
        const counter = itemCounter++; 
        const initialContent = (type === 'file') ? `Tulis konten file baru di sini.` : null;

        if (type === 'folder') {
            name = `Folder Baru ${counter}`;
        } else {
            name = `file_baru_${counter}.txt`;
        }
        
        const parentUUID = parentId ? parentId.replace('item-', '') : null;
        
        const { error } = await supabase
            .from('folder_items')
            .insert({ name: name, type: type, parent_id: parentUUID, content: initialContent }); 

        if (error) { 
            console.error("Gagal menyimpan ke Supabase:", error); 
            alert(`Gagal menyimpan! Nama: ${name}. Error: ${error.message}`); 
            return; 
        }
        
        await fetchAndRenderItems(); 
        
        if (parentId) {
            const parentElement = document.getElementById(parentId);
            if(parentElement) parentElement.classList.add('expanded');
        }
    };
    
    window.editItemName = function(itemId) {
        const item = document.getElementById(itemId);
        const header = item.querySelector('.item-header');
        const nameSpan = item.querySelector('.item-name');
        const iconSpan = item.querySelector('.icon');
        
        if (item.querySelector('.item-edit-input')) return; 
        
        const currentName = nameSpan.textContent.trim();
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'item-edit-input';
        input.value = currentName;

        nameSpan.style.display = 'none';
        iconSpan.style.display = 'none';
        header.insertBefore(input, header.querySelector('.controls'));
        
        input.focus();
        input.select(); 

        const saveNewName = async (newName) => {
            const trimmedName = newName.trim();
            if (trimmedName && trimmedName !== currentName) {
                const itemUUID = itemId.replace('item-', '');
                
                const { error } = await supabase
                    .from('folder_items')
                    .update({ name: trimmedName })
                    .eq('id', itemUUID);

                if (error) { 
                    console.error("Gagal mengupdate:", error); 
                    alert("Gagal mengupdate nama!"); 
                    // Jika gagal, kembalikan ke nama lama
                    nameSpan.textContent = currentName; 
                } else {
                    nameSpan.textContent = trimmedName;
                    // Update ikon jika ini file
                    if (item.classList.contains('file')) {
                       iconSpan.textContent = getFileIcon(trimmedName);
                    }
                }
            } else {
                 nameSpan.textContent = currentName;
            }
            
            input.remove();
            nameSpan.style.display = 'flex'; 
            iconSpan.style.display = 'block';
            fetchAndRenderItems(); 
        };

        input.onblur = () => { saveNewName(input.value); };
        input.onkeyup = (e) => {
            if (e.key === 'Enter') { input.blur(); } 
            else if (e.key === 'Escape') { saveNewName(currentName); }
        };
    };

    window.deleteItem = async function(itemId) {
        if (!confirm('Yakin ingin menghapus item ini dan semua isinya? Aksi ini permanen!')) return;
        
        const itemUUID = itemId.replace('item-', '');
        
        const { error } = await supabase
            .from('folder_items')
            // Menggunakan rpc atau logic di RLS Supabase untuk menghapus anak-anak
            .delete() 
            .eq('id', itemUUID);

        if (error) { 
            console.error("Gagal menghapus:", error); 
            alert(`Gagal menghapus! Error: ${error.message}`); 
            return; 
        }
        
        if (selectedItemId === itemUUID) {
             document.getElementById('content-title').textContent = 'Pilih File untuk Melihat Konten';
             document.getElementById('content-type').textContent = '';
             document.getElementById('file-editor').textContent = 'Silakan pilih file baru.';
             document.getElementById('file-editor').contentEditable = 'false';
             selectedItemId = null;
             selectedItemName = null;
             document.getElementById('download-button').style.display = 'none'; 
        }

        fetchAndRenderItems(); 
    };
    
    window.selectItem = async function(itemId) {
        const item = document.getElementById(itemId);
        const isFolder = item.classList.contains('folder');
        const itemUUID = itemId.replace('item-', '');
        const editor = document.getElementById('file-editor');
        const downloadButton = document.getElementById('download-button');
        
        let name = item.querySelector('.item-header .item-name').textContent.trim();
        
        // 1. Toggle Folder
        if (isFolder) {
            // Hindari toggle jika klik datang dari tombol ellipsis atau menu
            if (!event.target.closest('.controls')) {
                 item.classList.toggle('expanded'); 
            }
             // Di mobile, tutup sidebar saat folder diklik untuk melihat konten (jika folder diklik)
            if (window.innerWidth <= 900 && item.classList.contains('selected')) {
                toggleSidebar();
            }
        }

        // 2. Hapus Listener Autosave lama (jika ada)
        if (autosaveListener) {
            editor.removeEventListener('input', autosaveListener);
            autosaveListener = null;
            saveStatus.textContent = ''; 
        }
        
        // 3. Seleksi & Update Global State
        document.querySelectorAll('.folder-list li').forEach(li => li.classList.remove('selected'));
        item.classList.add('selected');
        
        selectedItemId = itemUUID;
        selectedItemName = name; 
        
        document.getElementById('content-title').textContent = name;
        document.getElementById('content-type').textContent = isFolder ? 'Folder' : 'File';
        editor.contentEditable = isFolder ? 'false' : 'true';

        // 4. Ambil Konten & Atur Tombol Unduh
        if (!isFolder) {
            // Ambil dari cache
            const itemData = allItemsData.find(i => i.id.toString() === itemUUID);

            if (itemData) {
                editor.textContent = itemData.content || ''; 
            } else {
                 editor.textContent = "Memuat konten...";
                 // Ambil dari Supabase jika tidak ada di cache (fallback, jarang terjadi)
                 const { data, error } = await supabase
                    .from('folder_items')
                    .select('content')
                    .eq('id', itemUUID)
                    .single();

                if (error) {
                    editor.textContent = `Gagal memuat konten: ${error.message}`;
                    console.error("Error loading content:", error);
                } else if (data) {
                    editor.textContent = data.content || ''; 
                }
            }
            
            downloadButton.style.display = 'inline-block'; 

            // 5. Tambahkan Listener Autosave BARU
            autosaveListener = debouncedAutoSave; 
            editor.addEventListener('input', autosaveListener);
            saveStatus.textContent = 'Menunggu perubahan...';
            saveStatus.style.color = 'var(--subtext)';
            
            // Di mobile, tutup sidebar setelah memilih file
            if (window.innerWidth <= 900) {
                toggleSidebar();
            }

        } else {
            editor.textContent = `Folder: ${name}\n\nFolder tidak dapat diedit di editor ini. Silakan navigasi ke dalamnya atau pilih file di dalamnya.`;
            downloadButton.style.display = 'none'; 
            saveStatus.textContent = '';
        }
    };
    
    document.addEventListener('DOMContentLoaded', fetchAndRenderItems);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorer Supabase Interaktif | Neon Edition</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- 1. VARIABEL WARNA NEON DARK --- */
        :root {
            --bg-dark: #0b0e16;
            --bg-card: #141829;
            --accent: #00ffc3; /* Neon Cyan */
            --accent2: #7a5cff; /* Neon Purple */
            --text: #f5f5f5;
            --subtext: #b0b0b0;
            --border: rgba(255,255,255,0.08);
            --hover-color: #1a223f; /* Hover background slightly brighter than card */
            --select-color: rgba(0, 255, 195, 0.15); /* Selected background */
            --danger-color: #ff5555;
            --success-color: #00e6a3;
            --header-height: 50px;
        }

        /* --- 2. RESET DAN LAYOUT UTAMA (DARK) --- */
        
        * { box-sizing:border-box; margin:0; padding:0; }

        body { 
            font-family:'Poppins', sans-serif;
            background:linear-gradient(145deg,#090d16,#101628); /* Dark Gradient */
            color:var(--text); 
            height: 100vh; 
            display: flex;
            flex-direction: column;
        }

        .header {
            height: var(--header-height);
            background-color: var(--accent2); /* Neon Purple Header */
            color: var(--text);
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(122, 92, 255, 0.3);
        }

        .file-explorer { 
            display: flex; 
            flex-grow: 1; 
        }

        /* --- 3. SIDEBAR (EXPLORER TREE) --- */

        .sidebar { 
            width: 300px; 
            background-color: var(--bg-card); /* Dark Card BG */
            border-right: 1px solid var(--border); 
            padding: 15px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 1.1em;
            font-weight: 600;
            color: var(--accent); /* Neon Cyan Title */
            text-shadow: 0 0 5px rgba(0,255,195,0.4);
        }

        .action-bar { 
            margin-bottom: 15px; 
            display: flex;
            gap: 8px;
        }
        .action-bar button { 
            background-color: var(--accent); /* Neon Cyan Button */
            color: var(--bg-dark); /* Dark Text on Button */
            border: none; 
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 0 8px rgba(0,255,195,0.5);
        }
        .action-bar button:hover { 
            background-color: #00e6a3; 
            box-shadow: 0 0 15px rgba(0,255,195,0.7);
        }

        /* --- 4. LIST FILE/FOLDER STYLING (DARK) --- */
        
        .folder-list { 
            list-style: none; 
            padding-left: 0; 
            margin: 0; 
            user-select: none;
        }
        
        .folder-list > li > ul.folder-list { 
            padding-left: 20px; 
            display: none; 
        }
        
        .folder-list li.expanded > ul.folder-list {
            display: block; 
        }
        
        .folder-list li {
            margin: 0; 
            position: relative;
        }

        .item-header {
            display: flex; 
            align-items: center;
            justify-content: space-between; 
            padding: 5px 8px; 
            cursor: pointer;
            border-radius: 3px;
        }

        .folder-list li:hover > .item-header { background-color: var(--hover-color); }
        .folder-list li.selected > .item-header { 
            background-color: var(--select-color); 
            font-weight: 500; 
            border: 1px solid var(--accent); /* Neon border on selection */
            padding: 4px 7px; /* Adjust padding for border */
        }
        
        /* Ikon Folder/File */
        .item-header::before { 
            content: " "; 
            display: inline-block; 
            width: 18px; 
            text-align: center; 
            margin-right: 6px; 
            vertical-align: middle; 
            font-size: 16px; 
            transition: transform 0.2s;
        }
        
        .folder-list li.file > .item-header::before { content: '📄'; color: var(--subtext); font-size: 14px;}
        .folder-list li.folder > .item-header::before { content: '📁'; color: var(--accent2); } /* Folder Icon: Neon Purple */
        .folder-list li.folder.expanded > .item-header::before { content: '📂'; } 
        
        .folder-list li.folder > .item-header .item-name::before {
            content: '▶';
            font-size: 8px;
            margin-right: 5px;
            color: var(--accent); /* Toggle Icon: Neon Cyan */
            transition: transform 0.2s;
            display: inline-block;
        }
        .folder-list li.folder.expanded > .item-header .item-name::before {
            content: '▼';
        }
        
        .item-name {
            flex-grow: 1; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px; 
            display: flex;
            align-items: center;
        }
        
        /* Style untuk input edit nama */
        .item-edit-input {
            flex-grow: 1;
            padding: 2px 4px;
            margin-right: -4px; 
            border: 1px solid var(--accent);
            border-radius: 3px;
            font-size: 1em;
            line-height: 1.2;
            box-sizing: border-box;
            background-color: var(--bg-dark);
            color: var(--text);
        }

        /* --- KONTROL ELIPSIS (NEON) --- */

        .controls {
            position: relative;
            flex-shrink: 0;
            padding-left: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .folder-list li:hover > .item-header .controls { opacity: 1; } 
        .controls.active { opacity: 1; } 

        .ellipsis-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            font-weight: bold;
            font-size: 1em;
            padding: 2px 5px;
            border-radius: 3px;
            transition: color 0.2s, background-color 0.2s;
        }
        .ellipsis-button:hover {
            background-color: var(--hover-color);
            color: var(--accent);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%; 
            right: 10px; 
            background-color: var(--bg-card);
            border: 1px solid var(--accent); /* Neon Border */
            box-shadow: 0 0 15px rgba(0,255,195,0.2);
            border-radius: 4px;
            z-index: 1000;
            min-width: 150px;
            padding: 5px 0;
            display: none;
        }

        .dropdown-menu.visible {
            display: block;
        }

        .dropdown-menu button {
            display: block;
            width: 100%;
            padding: 8px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text);
            white-space: nowrap;
        }

        .dropdown-menu button:hover {
            background-color: var(--hover-color);
            color: var(--accent);
        }
        /* Style khusus untuk tombol Hapus */
        .dropdown-menu button.delete-btn {
            color: var(--danger-color);
        }
        .dropdown-menu button.delete-btn:hover {
            background-color: rgba(255, 85, 85, 0.2);
            color: var(--danger-color);
        }

        /* --- 5. CONTENT PANEL (EDITOR) --- */

        .content-panel { 
            flex-grow: 1; 
            background-color: var(--bg-dark); 
            padding: 20px; 
            overflow-y: auto; 
        }

        .content-panel h3 {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(0,255,195,0.4);
            margin-top: 0;
            margin-bottom: 5px;
        }

        .file-content { 
            white-space: pre-wrap; 
            background-color: var(--bg-card); 
            padding: 15px; 
            border-radius: 5px; 
            min-height: 200px; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 0.9em; 
            border: 1px solid var(--border);
            height: 400px; 
            overflow: auto; 
            color: var(--text);
            transition: border-color 0.3s;
        }
        /* Highlight border saat dapat diedit */
        #file-editor[contenteditable="true"] {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 255, 195, 0.4);
        }

        /* SEMBUNYIKAN SAVE AREA */
        .save-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            visibility: hidden; /* Sembunyikan tombol simpan */
            height: 0;
        }
        
        #save-status {
            color: var(--success-color);
            font-weight: 500;
            text-shadow: 0 0 5px rgba(0, 230, 163, 0.5);
            visibility: visible; /* Tetap tampilkan status */
            height: auto;
        }
    </style>
</head>
<body>

<div class="header">
    <span style="margin-right: 10px;">⚡</span> Supabase File Explorer <span style="font-size: 0.7em; margin-left: 10px; color: #a9a9a9;">(Neon Edition)</span>
</div>

<div class="file-explorer">
    
    <div class="sidebar">
        <h2><span style="font-size: 1.2em;">🗂️</span> Struktur Direktori</h2>
        
        <div class="action-bar">
            <button onclick="addNewItem(null, 'folder'); toggleMenu(null);">➕ Folder</button>
            <button onclick="addNewItem(null, 'file'); toggleMenu(null);">➕ File</button>
        </div>

        <ul class="folder-list" id="root-list">
            <li style="text-align: center;">Memuat data...</li>
        </ul>
    </div>
    
    <div class="content-panel">
        <h3 id="content-title">Pilih File untuk Melihat Konten</h3>
        <p style="color: var(--subtext);">Tipe: <span id="content-type"></span></p>
        
        <div class="file-content" id="file-editor" contenteditable="false">
            Silakan tunggu hingga data dimuat. Setelah itu, klik pada file di sidebar kiri.
        </div>
        
        <div class="save-area">
            <button style="display:none;">Tombol Simpan Disembunyikan</button>
            <span id="save-status"></span>
        </div>
    </div>

</div>

<script>
    // ----------------------------------------------------------------------
    // --- 1. INISIALISASI SUPABASE & GLOBAL STATE ---
    // ----------------------------------------------------------------------
    
    const SUPABASE_URL = 'https://zawtfjszvkuudawrilqg.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphd3RmanN6dmt1dWRhd3JpbHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTk2NzMsImV4cCI6MjA3NDk5NTY3M30.CGYz4-QnYb3Hu9p3fV0XoG5J8oicqZsji-YJf2UItQ8';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let itemCounter = 1; 
    let selectedItemId = null; 
    let allItemsData = []; 

    // Variabel untuk menahan listener agar bisa dilepas
    let autosaveListener = null;

    // ----------------------------------------------------------------------
    // --- 2. DEBOUNCE UTILITY (PENTING UNTUK AUTOSAVE) ---
    // ----------------------------------------------------------------------

    /**
     * Fungsi Debounce untuk membatasi frekuensi pemanggilan fungsi
     * @param {function} func - Fungsi yang akan dipanggil
     * @param {number} delay - Jeda waktu (ms)
     */
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // ----------------------------------------------------------------------
    // --- 3. FUNGSI AUTOSAVE BARU ---
    // ----------------------------------------------------------------------
    
    const editor = document.getElementById('file-editor');
    const saveStatus = document.getElementById('save-status');
    
    /**
     * Fungsi yang dipanggil oleh Debounce untuk menyimpan konten file.
     */
    const autoSaveFileContent = async () => {
        const itemUUID = selectedItemId;
        const newContent = editor.textContent;

        if (!itemUUID) return; // Pastikan ada file yang terpilih

        // 1. Tampilkan status "Menyimpan..."
        saveStatus.textContent = 'Menyimpan...';
        saveStatus.style.color = '#fff';

        // 2. Lakukan Update ke Supabase
        const { error } = await supabase
            .from('folder_items')
            .update({ content: newContent })
            .eq('id', itemUUID);

        // 3. Tangani hasil
        if (error) {
            saveStatus.textContent = `Gagal menyimpan: ${error.message}`;
            saveStatus.style.color = 'var(--danger-color)';
            console.error("Error saving content:", error);
        } else {
            // Update cache data
            const cachedItem = allItemsData.find(i => i.id.toString() === itemUUID);
            if(cachedItem) cachedItem.content = newContent;

            // Tampilkan status "Tersimpan" sebentar
            saveStatus.textContent = 'Tersimpan!';
            saveStatus.style.color = 'var(--success-color)';
            setTimeout(() => { 
                // Hanya hapus status jika editor masih aktif pada file yang sama
                if (editor.contentEditable === 'true' && selectedItemId === itemUUID) {
                    saveStatus.textContent = 'Menunggu perubahan...';
                    saveStatus.style.color = 'var(--subtext)';
                }
            }, 3000);
        }
    };

    // Buat versi debounced dari fungsi autosave (misalnya, tunda 500ms setelah user berhenti mengetik)
    const debouncedAutoSave = debounce(autoSaveFileContent, 500);

    // ----------------------------------------------------------------------
    // --- 4. FUNGSI RENDER DAN LOGIC (Hampir tidak ada perubahan di sini) ---
    // ----------------------------------------------------------------------

    function createItemElement(itemData) {
        const itemId = `item-${itemData.id}`;
        const itemClass = itemData.type === 'folder' ? 'folder' : `file`; 
        const li = document.createElement('li');
        li.className = itemClass;
        li.id = itemId;
        const isFolder = itemData.type === 'folder';

        const folderActions = isFolder 
            ? `
                <button onclick="addNewItem('${itemId}', 'folder'); toggleMenu('${itemId}');">➕ Tambah Folder</button>
                <button onclick="addNewItem('${itemId}', 'file'); toggleMenu('${itemId}');">➕ Tambah File</button>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 5px 0;">
              `
            : '';

        li.innerHTML = `
            <div class="item-header" onclick="selectItem('${itemId}')">
                <span class="item-name">${itemData.name}</span>
                <div class="controls" id="controls-${itemId}">
                    <button class="ellipsis-button" onclick="event.stopPropagation(); toggleMenu('${itemId}')">•••</button>
                    <div class="dropdown-menu" id="menu-${itemId}">
                        ${folderActions}
                        <button onclick="editItemName('${itemId}'); toggleMenu('${itemId}');">✏️ Edit Nama</button>
                        <button class="delete-btn" onclick="deleteItem('${itemId}'); toggleMenu('${itemId}');">🗑️ Hapus</button>
                    </div>
                </div>
            </div>
            ${isFolder ? '<ul class="folder-list"></ul>' : ''}
        `;
        return li;
    }

    function buildTree(items) {
        const rootItems = [];
        const itemsMap = {};
        items.forEach(item => { 
             const idStr = item.id.toString(); 
             const parentIdStr = item.parent_id ? item.parent_id.toString() : null;
             itemsMap[idStr] = {...item, id: idStr, parent_id: parentIdStr, children: []}; 
        });
        
        Object.values(itemsMap).forEach(item => {
            if (item.parent_id === null) {
                rootItems.push(item);
            } else if (itemsMap[item.parent_id]) {
                itemsMap[item.parent_id].children.push(item);
            }
        });
        return rootItems;
    }

    function renderTree(items, ulElement) {
        items.sort((a, b) => (b.type === 'folder') - (a.type === 'folder') || a.name.localeCompare(b.name));
        
        items.forEach(item => {
            const li = createItemElement(item);
            ulElement.appendChild(li);
            
            if (item.type === 'folder' && item.children.length > 0) {
                const newUl = document.createElement('ul');
                newUl.className = 'folder-list';
                li.appendChild(newUl);
                renderTree(item.children, newUl);
            }
        });
    }

    window.toggleMenu = function(itemId) {
        const menu = itemId ? document.getElementById(`menu-${itemId}`) : null;
        
        document.querySelectorAll('.dropdown-menu.visible').forEach(openMenu => {
            if (!itemId || openMenu.id !== `menu-${itemId}`) {
                openMenu.classList.remove('visible');
                openMenu.parentNode.classList.remove('active');
            }
        });

        if (menu) {
            const controls = document.getElementById(`controls-${itemId}`);
            menu.classList.toggle('visible');
            controls.classList.toggle('active');
        }
    };

    document.addEventListener('click', function(event) {
        let isInsideMenu = event.target.closest('.dropdown-menu, .ellipsis-button');
        if (!isInsideMenu) {
            toggleMenu(null);
        }
    });


    // ----------------------------------------------------------------------
    // --- 5. FUNGSI CRUD & LOGIC UTAMA (PENAMBAHAN LOGIKA AUTOSAVE) ---
    // ----------------------------------------------------------------------

    window.fetchAndRenderItems = async function() {
        const rootList = document.getElementById('root-list');
        rootList.innerHTML = '<li style="text-align: center;">Memuat data...</li>';

        const { data, error } = await supabase
            .from('folder_items')
            .select('*'); 

        if (error) {
            console.error("Gagal mengambil data:", error);
            rootList.innerHTML = `<li style="color: var(--danger-color);">ERROR: Gagal memuat data. Periksa kunci Supabase, tabel 'folder_items', dan RLS.</li>`;
            return;
        }

        allItemsData = data; 
        rootList.innerHTML = '';
        const tree = buildTree(data);
        renderTree(tree, rootList);
    }
    
    window.addNewItem = async function(parentId, type) {
        let name;
        const counter = itemCounter++; 
        const initialContent = (type === 'file') ? `Tulis konten file baru di sini.` : null;

        if (type === 'folder') {
            name = `Folder Baru ${counter}`;
        } else {
            name = `file_baru_${counter}.txt`;
        }
        
        const parentUUID = parentId ? parentId.replace('item-', '') : null;
        
        const { error } = await supabase
            .from('folder_items')
            .insert({ name: name, type: type, parent_id: parentUUID, content: initialContent }); 

        if (error) { 
            console.error("Gagal menyimpan ke Supabase:", error); 
            alert(`Gagal menyimpan! Nama: ${name}. Error: ${error.message}`); 
            return; 
        }
        
        await fetchAndRenderItems(); 
        
        if (parentId) {
            const parentElement = document.getElementById(parentId);
            if(parentElement) parentElement.classList.add('expanded');
        }
    };
    
    window.editItemName = function(itemId) {
        const item = document.getElementById(itemId);
        const header = item.querySelector('.item-header');
        const nameSpan = item.querySelector('.item-name');
        
        if (item.querySelector('.item-edit-input')) return; 
        
        const currentName = nameSpan.textContent.trim();
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'item-edit-input';
        input.value = currentName;
        input.style.display = 'block'; 

        nameSpan.style.display = 'none';
        header.insertBefore(input, nameSpan);
        
        input.focus();
        input.select(); 

        const saveNewName = async (newName) => {
            if (newName && newName.trim() !== currentName) {
                const itemUUID = itemId.replace('item-', '');
                
                const { error } = await supabase
                    .from('folder_items')
                    .update({ name: newName.trim() })
                    .eq('id', itemUUID);

                if (error) { 
                    console.error("Gagal mengupdate:", error); 
                    alert("Gagal mengupdate nama!"); 
                    newName = currentName; 
                }
                
                nameSpan.textContent = newName.trim();
                
            }
            input.remove();
            nameSpan.style.display = 'block'; 
            fetchAndRenderItems(); 
        };

        input.onblur = () => {
            saveNewName(input.value);
        };

        input.onkeyup = (e) => {
            if (e.key === 'Enter') {
                input.blur(); 
            } else if (e.key === 'Escape') {
                saveNewName(currentName); 
            }
        };
    };

    window.deleteItem = async function(itemId) {
        if (!confirm('Yakin ingin menghapus item ini dan semua isinya (jika folder)?')) return;
        
        const itemUUID = itemId.replace('item-', '');
        
        const { error } = await supabase
            .from('folder_items')
            .delete()
            .eq('id', itemUUID);

        if (error) { 
            console.error("Gagal menghapus:", error); 
            alert(`Gagal menghapus! Error: ${error.message}`); 
            return; 
        }
        
        if (selectedItemId === itemUUID) {
             document.getElementById('content-title').textContent = 'Pilih File untuk Melihat Konten';
             document.getElementById('content-type').textContent = '';
             document.getElementById('file-editor').textContent = 'Silakan pilih file baru.';
             document.getElementById('file-editor').contentEditable = 'false';
             selectedItemId = null;
        }

        fetchAndRenderItems(); 
    };
    
    window.selectItem = async function(itemId) {
        const item = document.getElementById(itemId);
        const isFolder = item.classList.contains('folder');
        const itemUUID = itemId.replace('item-', '');
        const editor = document.getElementById('file-editor');
        
        let name = item.querySelector('.item-header .item-name').textContent.trim();
        
        // 1. Toggle Folder
        if (isFolder) {
            if (!event.target.closest('.controls')) {
                 item.classList.toggle('expanded'); 
            }
            toggleMenu(null);
        }

        // 2. Hapus Listener Autosave lama (jika ada)
        if (autosaveListener) {
            editor.removeEventListener('input', autosaveListener);
            autosaveListener = null;
            saveStatus.textContent = ''; // Kosongkan status saat berpindah item
        }
        
        // 3. Seleksi
        document.querySelectorAll('.folder-list li').forEach(li => li.classList.remove('selected'));
        item.classList.add('selected');
        
        selectedItemId = itemUUID;
        document.getElementById('content-title').textContent = name;
        document.getElementById('content-type').textContent = isFolder ? 'Folder' : 'File';
        editor.contentEditable = isFolder ? 'false' : 'true';

        // 4. Ambil Konten (Hanya untuk File)
        if (!isFolder) {
            editor.textContent = "Memuat konten...";
            
            const itemData = allItemsData.find(i => i.id.toString() === itemUUID);

            if (itemData) {
                editor.textContent = itemData.content || ''; 
            } else {
                 const { data, error } = await supabase
                    .from('folder_items')
                    .select('content')
                    .eq('id', itemUUID)
                    .single();

                if (error) {
                    editor.textContent = `Gagal memuat konten: ${error.message}`;
                    console.error("Error loading content:", error);
                } else if (data) {
                    editor.textContent = data.content || ''; 
                }
            }
            
            // 5. Tambahkan Listener Autosave BARU
            autosaveListener = debouncedAutoSave; // Gunakan fungsi debounced
            editor.addEventListener('input', autosaveListener);
            saveStatus.textContent = 'Menunggu perubahan...';
            saveStatus.style.color = 'var(--subtext)';

        } else {
            editor.textContent = `--- Ini adalah Folder (${name}). Tidak ada konten yang dapat diedit di sini. ---`;
        }
    };
    
    // Fungsi saveFileContent lama dihilangkan karena digantikan oleh autoSaveFileContent
    
    document.addEventListener('DOMContentLoaded', fetchAndRenderItems);
</script>

</body>
</html>

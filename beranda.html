<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link rel="icon" href="ikon2.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0b0e16;
  --bg-card: #141829;
  --accent: #00ffc3; /* Neon Cyan */
  --accent2: #7a5cff; /* Neon Purple */
  --text: #f5f5f5;
  --subtext: #b0b0b0;
  --border: rgba(255,255,255,0.08);
  --shadow-glow: 0 0 15px rgba(0,255,195,0.2);
}
* { box-sizing:border-box; margin:0; padding:0; }
body {
  min-height:100vh; 
  font-family:'Poppins',sans-serif;
  background:linear-gradient(145deg, #070a13, #101628); /* Gradien lebih gelap */
  color:var(--text);
  display:flex; 
  align-items:center; 
  justify-content:center;
  text-align:center; 
  flex-direction:column; 
  overflow-x:hidden; /* Hindari scroll horizontal */
  padding-bottom: 60px; /* Ruang untuk footer */
}

/* Header Info */
.header-container {
    width: 100%;
    max-width: 1200px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: absolute;
    top: 0;
    z-index: 10;
}
.time-info { 
    text-align:left; 
    line-height:1.3; 
    animation:fadeIn 1.2s ease; 
}
.time-info h1{ 
    font-size:2.2em; /* Lebih besar di PC */
    color:var(--accent); 
    margin-bottom:4px; 
    font-weight:700;
    text-shadow:0 0 15px rgba(0,255,195,0.6); /* Glow lebih kuat */
}
.time-info h2{ 
    font-size:1.1em; 
    color:var(--accent2); 
    font-weight:400;
    text-shadow:0 0 10px rgba(122,92,255,0.4); 
}
.clock { 
    font-size:1.8em; 
    color:var(--accent); 
    text-shadow:0 0 10px rgba(0,255,195,0.4); 
    animation:fadeIn 1.2s ease; 
    font-weight:600; 
    margin-top: 5px;
}

/* Main Content (Untuk PC: Tampilan Kolom) */
.main { 
    width: 100%;
    max-width: 1200px;
    padding: 20px;
    display: flex; /* Aktifkan Flexbox untuk layout PC */
    gap: 30px; /* Jarak antar kolom */
    margin-top: 120px; /* Jarak dari header atas */
}
.card { 
    background:var(--bg-card); 
    border:1px solid var(--border); 
    border-radius:18px; /* Sudut lebih membulat */
    padding:30px; /* Padding lebih besar */
    box-shadow:0 0 30px rgba(0,0,0,0.5); /* Shadow lebih dalam */
    transition:transform 0.4s ease, box-shadow 0.4s ease; 
    flex: 1; /* Biarkan card membagi ruang secara merata */
    min-height: 400px; /* Tinggi minimum agar terlihat proporsional */
    text-align: left; /* Teks di dalam card rata kiri */
}
.card:hover { 
    transform:translateY(-6px); /* Perubahan hover lebih dramatis */
    box-shadow:0 10px 40px rgba(0,0,0,0.6), 0 0 20px rgba(0,255,195,0.2); 
}
.card h3{ 
    color:var(--accent); 
    margin-bottom:20px; 
    font-size:1.4em; /* Judul lebih besar */
    font-weight:600;
    border-bottom: 2px solid var(--accent); /* Garis bawah elegan */
    padding-bottom: 10px;
}
.card p{ color:var(--subtext); line-height:1.7; white-space:pre-line; }
footer{ position:fixed; bottom:0; width:100%; padding:10px; font-size:0.85em; color:#777; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:10; }
@keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

/* Jadwal Table Styling */
.schedule-table { width:100%; border-collapse:separate; border-spacing:0; text-align:left; font-size:0.95em; margin-top:10px; border-radius:10px; overflow:hidden; }
.schedule-table th, .schedule-table td{ padding:12px 15px; border:none; }
.schedule-table th{ color:var(--accent2); background:rgba(122,92,255,0.1); font-weight:600; }
.schedule-table td{ color:var(--text); border-bottom:1px solid var(--border);}
.schedule-table tbody tr:nth-child(even){ background:rgba(255,255,255,0.03);}
.schedule-table tbody tr:hover{ background:rgba(0,255,195,0.1); transform:scale(1.01); transition:0.3s;}

/* Gaya Sorotan Jadwal Sedang Berlangsung (Neon Glow Intens) */
.active-class {
    background: linear-gradient(90deg, #008f76 0%, #006b5a 100%) !important; 
    border-left: 5px solid var(--accent) !important; /* Indikator tebal di kiri */
    box-shadow: 0 0 15px var(--accent) inset, 0 0 8px rgba(0,255,195,0.8); 
    font-weight: bold;
    transition: all 0.5s;
    transform:scale(1.02);
}
.active-class td {
    color: #fff !important; 
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}

/* Gaya Daftar Tugas */
.todo-container { padding-right: 10px; /* Ruang untuk scrollbar di PC */ }
#todo-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
/* Style Scrollbar Kustom (Hanya untuk PC) */
#todo-list::-webkit-scrollbar { width: 6px; }
#todo-list::-webkit-scrollbar-thumb { background: var(--accent2); border-radius: 3px; }
#todo-list::-webkit-scrollbar-track { background: var(--bg-card); }

#todo-list li {
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  display: flex; 
  align-items: center;
  justify-content: space-between;
  animation: fadeIn 0.8s ease;
}
#todo-list li:last-child { border-bottom: none; }
#todo-list li .task-details { flex-grow: 1; }
#todo-list li .task-title {
    font-weight: 600;
    color: var(--text);
    display: block;
    font-size: 1.05em;
}
#todo-list li .task-due {
    font-size: 0.8em;
    color: var(--subtext);
    display: block;
    margin-top: 4px;
}
/* Style untuk batas waktu yang sudah lewat */
#todo-list li .task-due.overdue {
    color: #ff7777; 
    font-weight: bold;
}
/* Gaya Tombol Selesai */
.done-btn {
    background: var(--accent);
    color: var(--bg-card);
    padding: 8px 16px; /* Lebih besar */
    border: none;
    border-radius: 8px; /* Lebih membulat */
    font-size: 0.9em;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    margin-left: 15px;
}
.done-btn:hover {
    background: #00e6a3;
    box-shadow: 0 0 10px var(--accent);
}


/* --- RESPONSIVE (MOBILE) --- */
@media (max-width:768px){
  body { padding-bottom: 40px; }
  .header-container { flex-direction: column; align-items: center; padding: 15px; }
  .time-info{ text-align:center; width: 100%; margin-bottom: 10px; }
  .time-info h1{ font-size:1.8em;}
  .time-info h2{ font-size:0.9em;}
  .clock{ position:static; font-size:1.5em; margin-bottom: 0; }
  
  /* Main Content (Untuk HP: Tampilan Stack) */
  .main{ 
    flex-direction: column; /* Ubah menjadi kolom */
    gap: 20px;
    padding: 15px;
    margin-top: 100px; /* Jarak dari header */
  }
  .card{ 
    width:100%; 
    min-height: unset; /* Hapus min-height */
    padding: 20px;
  }
  .card:hover { transform:none; box-shadow:0 0 20px rgba(0,0,0,0.3); } /* Hapus hover di HP */
  .card h3{ font-size:1.2em; margin-bottom: 15px; }

  .schedule-table th, .schedule-table td{ padding: 10px; font-size: 0.85em; }

  .done-btn {
      padding: 6px 10px; 
      font-size: 0.8em;
  }

  /* Sembunyikan hari/guru di tampilan HP untuk menghemat ruang */
  .schedule-table th:first-child, 
  .schedule-table td:first-child,
  .schedule-table th:last-child, 
  .schedule-table td:last-child {
      display: none; 
  }
}
</style>
</head>
<body>

<div class="header-container">
    <div class="time-info">
      <h1 id="greeting">Selamat Datang, Khalid</h1>
      <h2 id="today">Memuat tanggal...</h2>
    </div>
    <div class="clock" id="clock">00:00:00</div>
</div>

<div class="main">
  <div class="card">
    <h3>Daftar Semua Tugas</h3>
    <div class="todo-container">
        <ul id="todo-list">
            <li>Memuat tugas...</li>
        </ul>
    </div>
  </div>

  <div class="card">
    <h3>Jadwal Pelajaran Hari Ini</h3>
    <table class="schedule-table" id="schedule-table">
      <thead>
        <tr>
          <th>Hari</th> <th>Jam</th>
          <th>Mapel</th>
          <th>Guru</th> </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="no-schedule" style="margin-top:20px; color:var(--subtext); display:none;">Tidak ada jadwal pelajaran untuk hari ini. Waktunya santai!</p>
  </div>
</div>

<footer>© 2025 Khalid — Ruang Pribadi.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ======================
// Konstanta Supabase
// ======================
const supabaseUrl = "https://bwfoeapwqdrinqgccxpw.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3Zm9lYXB3cWRyaW5xZ2NjeHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTUzNTYsImV4cCI6MjA3NTM5MTM1Nn0.grJkA6XjIvAOWzmWTMx-Rp8BUVdvwTd_pawNQsM0Vt8";
const supa = supabase.createClient(supabaseUrl, supabaseKey);


// ======================
// Tanggal & Jam
// ======================
function updateDate(){ const date=new Date(); document.getElementById('today').textContent=date.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'});}
function updateGreeting(){ const hour=new Date().getHours(); let g=""; if(hour>=4&&hour<11)g="Selamat Pagi"; else if(hour>=11&&hour<15) g="Selamat Siang"; else if(hour>=15&&hour<18) g="Selamat Sore"; else g="Selamat Malam"; document.getElementById("greeting").textContent=g+", Khalid";}
function updateClock(){ const now=new Date(); let h=now.getHours().toString().padStart(2,'0'), m=now.getMinutes().toString().padStart(2,'0'), s=now.getSeconds().toString().padStart(2,'0'); document.getElementById("clock").textContent=`${h}:${m}:${s} WIB`;}
updateDate(); updateGreeting(); updateClock();
// Memuat jadwal setiap detik untuk update status "active-class"
setInterval(()=>{ updateDate(); updateGreeting(); updateClock(); loadJadwal(); },1000);


// ======================
// FUNGSI UTAMA PENGUBAH STATUS TUGAS
// ======================
async function markTaskAsDone(taskId) {
    const li = document.getElementById(`task-${taskId}`);
    if (li) {
        const btn = li.querySelector('.done-btn');
        btn.textContent = 'Memproses...';
        btn.disabled = true;
    }

    const { error } = await supa
        .from('tugas')
        .update({ is_done: true }) 
        .eq('id', taskId); 

    if (error) {
        console.error("Gagal memperbarui status tugas:", error);
        alert(`Gagal menyelesaikan tugas: ${error.message}.`);
        if (li) {
            li.querySelector('.done-btn').textContent = 'Selesai';
            li.querySelector('.done-btn').disabled = false;
        }
        return;
    }

    loadTugas(); 
}


// ======================
// Daftar Tugas dari Supabase (Tabel: public.tugas)
// ======================
const todoList = document.getElementById("todo-list");

async function loadTugas() {
  todoList.innerHTML = "<li>Memuat tugas...</li>";

  const { data, error } = await supa
    .from("tugas") 
    .select("id, judul, tanggal_awal, tanggal_akhir, is_done") 
    .eq('is_done', false) 
    .order('tanggal_akhir', { ascending: true }) // Urutkan berdasarkan batas waktu terdekat
    .order('tanggal_awal'); 

  if (error) {
    console.error("Error fetching tasks:", error);
    todoList.innerHTML = `<li style="color:#ff5555;">Gagal memuat daftar tugas: ${error.message}.</li>`;
    return;
  }
  
  renderTugas(data);
}

function renderTugas(tasks) {
  todoList.innerHTML = "";
  const today = new Date();
  today.setHours(0, 0, 0, 0); 
  
  if (!tasks || tasks.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Tidak ada tugas aktif yang belum selesai saat ini. Kerja bagus!";
    li.style.color = "var(--subtext)";
    todoList.appendChild(li);
  } else {
    tasks.forEach(task => {
      const li = document.createElement("li");
      li.id = `task-${task.id}`; 
      
      const start = task.tanggal_awal ? new Date(task.tanggal_awal) : null;
      const end = task.tanggal_akhir ? new Date(task.tanggal_akhir) : null;
      
      let dueText = '';
      let dateStatusClass = '';

      // Tentukan Batas Waktu
      if (end) {
          const endDateString = end.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
          
          dueText = `Batas Waktu: ${endDateString}`;
          if (end < today && task.is_done !== true) {
              dateStatusClass = 'overdue'; // Tugas Terlambat
          }
      } else {
           dueText = `Batas Waktu: Tidak Ditentukan`;
      }

      // Tentukan Tanggal Mulai (Optional)
      if (start && end && start.getTime() !== end.getTime()) {
          const startDateString = start.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
          dueText = `Mulai: ${startDateString} | ${dueText}`;
      } else if (start && !end) {
          const startDateString = start.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
          dueText = `Mulai: ${startDateString}`;
      }
      
      li.innerHTML = `
          <div class="task-details">
              <span class="task-title">${task.judul || "Tugas Tanpa Judul"}</span>
              <span class="task-due ${dateStatusClass}">${dueText || 'Tanggal tidak tersedia'}</span>
          </div>
          <button class="done-btn" onclick="markTaskAsDone(${task.id})">Selesai</button>
      `;
      
      todoList.appendChild(li);
    });
  }
}


// ======================
// Jadwal Pelajaran (Tampilkan berdasarkan Hari Ini)
// ======================
const tbody = document.querySelector("#schedule-table tbody");
let jadwalData=[];

async function loadJadwal(){
  const {data,error} = await supa.from("jadwal_pelajaran").select("*").order('id');
  if(error){ console.error(error); return; }
  jadwalData = data;
  renderTable();
}

function renderTable(){
  tbody.innerHTML = "";
  const now = new Date();
  const nowMinutes = now.getHours()*60 + now.getMinutes();
  const todayName = now.toLocaleDateString('id-ID',{weekday:'long'}); 
  let hasSchedule = false;

  // 1. Filter jadwal hanya untuk hari ini
  const scheduleForToday = jadwalData.filter(item => item.hari === todayName);

  if (scheduleForToday && scheduleForToday.length > 0) {
      hasSchedule = true;
      
      // 2. Tidak perlu header hari di dalam table karena card sudah spesifik "Hari Ini"

      // 3. Urutkan mata pelajaran hari ini berdasarkan jam mulai
      scheduleForToday.sort((a, b) => {
          // Fungsi untuk mengubah format jam "HH:MM" menjadi menit total
          const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(Number);
            return parts.length === 2 ? parts[0] * 60 + parts[1] : 0;
          };
          
          const startA = a.jam.split('–')[0].trim();
          const startB = b.jam.split('–')[0].trim();
          return timeToMinutes(startA) - timeToMinutes(startB);
      });

      // 4. Tambahkan Baris Mata Pelajaran
      scheduleForToday.forEach(item => {
        let rowClass = '';
        
        // Cek apakah mata pelajaran sedang aktif saat ini
        if(item.jam && item.jam.includes('–')){
            const [start, end] = item.jam.split('–').map(t=>t.trim());
            const startParts = start.split(':');
            const endParts   = end.split(':');

            if(startParts.length===2 && endParts.length===2){
                const startMinutes = parseInt(startParts[0])*60 + parseInt(startParts[1]);
                const endMinutes   = parseInt(endParts[0])*60 + parseInt(endParts[1]);

                if(nowMinutes >= startMinutes && nowMinutes < endMinutes){ 
                    rowClass = 'active-class'; 
                }
            }
        }
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${item.hari || "-"}</td> 
          <td>${item.jam || "-"}</td>
          <td>${item.mapel || "-"}</td>
          <td>${item.guru || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // Tampilkan/sembunyikan pesan "Tidak ada jadwal"
  document.getElementById('no-schedule').style.display = hasSchedule ? "none" : "block";
  document.getElementById('schedule-table').style.display = hasSchedule ? 'table' : 'none';
}

// ======================
// Load Data Awal
// ======================
loadJadwal();
loadTugas(); 
</script>
</body>
</html>
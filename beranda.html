<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruang Pribadi Khalid</title>
<link rel="icon" href="ikon2.png" type="image/png">
<style>
:root {
  --bg-dark: #0b0e16;
  --bg-card: #141829;
  --accent: #00ffc3; /* Neon Cyan */
  --accent2: #7a5cff;
  --text: #f5f5f5;
  --subtext: #b0b0b0;
  --border: rgba(255,255,255,0.08);
}
* { box-sizing:border-box; margin:0; padding:0; }
body {
  min-height:100vh; font-family:'Poppins',sans-serif;
  background:linear-gradient(145deg,#090d16,#101628);
  color:var(--text);
  display:flex; align-items:center; justify-content:center;
  text-align:center; flex-direction:column; overflow:auto;
}
.time-info { position:absolute; top:20px; left:25px; text-align:left; line-height:1.3; animation:fadeIn 1.2s ease; }
.time-info h1{ font-size:2em; color:var(--accent); margin-bottom:4px; text-shadow:0 0 10px rgba(0,255,195,0.5);}
.time-info h2{ font-size:1em; color:var(--accent2); text-shadow:0 0 10px rgba(122,92,255,0.5); }
.clock { position:absolute; top:20px; right:25px; font-size:1.6em; color:var(--accent); text-shadow:0 0 10px rgba(0,255,195,0.4); animation:fadeIn 1.2s ease; font-weight:500; }
.main { max-width:800px; padding:0 20px; }
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:25px; margin-top:30px; box-shadow:0 0 25px rgba(0,0,0,0.3); transition:0.3s; }
.card:hover { transform:translateY(-4px); box-shadow:0 0 35px rgba(0,255,195,0.15); }
.card h3{ color:var(--accent); margin-bottom:15px; font-size:1.2em; }
.card p{ color:var(--subtext); line-height:1.7; white-space:pre-line; }
footer{ position:absolute; bottom:20px; font-size:0.85em; color:#777; }
@keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
.schedule-table { width:100%; border-collapse:collapse; text-align:left; font-size:0.95em; margin-top:10px; }
.schedule-table th, .schedule-table td{ padding:10px 12px; border:1px solid var(--border); }
.schedule-table th{ color:var(--accent2); text-shadow:0 0 5px rgba(122,92,255,0.4);}
.schedule-table td{ color:var(--text);}
.schedule-table tbody tr:nth-child(even){ background:rgba(255,255,255,0.03);}
.schedule-table tbody tr:hover{ background:rgba(0,255,195,0.1); transition:0.3s;}

/* Gaya Sorotan Jadwal Sedang Berlangsung BARU (Neon Glow) */
.active-class {
    background: #008f76 !important; /* Latar belakang hijau pekat */
    border: 1px solid var(--accent) !important;
    /* Efek bayangan luar (glow) */
    box-shadow: 0 0 12px var(--accent), inset 0 0 8px var(--accent); 
    font-weight: bold;
    transition: all 0.5s;
}
.active-class td {
    color: var(--bg-card) !important; /* Teks berwarna gelap untuk kontras */
}

/* Gaya Daftar Tugas */
.todo-container { text-align: left; }
#todo-list { list-style: none; padding: 0; }
#todo-list li {
  padding: 10px 5px;
  border-bottom: 1px solid var(--border);
  word-break: break-word;
  display: flex; 
  align-items: center;
}
#todo-list li:last-child { border-bottom: none; }
#todo-list li .task-details {
    flex-grow: 1; 
}
#todo-list li .task-title {
    font-weight: 500;
    color: var(--text);
    display: block;
}
#todo-list li .task-due {
    font-size: 0.85em;
    color: var(--subtext);
    display: block;
    margin-top: 2px;
}
/* Style untuk batas waktu yang sudah lewat */
#todo-list li .task-due.overdue {
    color: #ff5555; 
    font-weight: bold;
}
/* Gaya Tombol Selesai */
.done-btn {
    background: var(--accent);
    color: var(--bg-card);
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85em;
    cursor: pointer;
    transition: opacity 0.3s, background 0.3s;
    margin-left: 15px;
}
.done-btn:hover {
    background: #00e6a3;
}


@media (max-width:600px){
  .time-info{ top:15px; left:15px;}
  .time-info h1{ font-size:1.3em;}
  .time-info h2{ font-size:1em;}
  .clock{ top:15px; right:25px; font-size:1.2em;}
  .card{ width:90%; margin:20px auto;}
}
</style>
</head>
<body>

<div class="time-info">
  <h1 id="greeting">Selamat Datang, Khalid</h1>
  <h2 id="today">Memuat tanggal...</h2>
</div>

<div class="clock" id="clock">00:00:00</div>

<div class="main">
  <div class="card">
    <h3>Daftar Semua Tugas</h3>
    <div class="todo-container">
        <ul id="todo-list">
            <li>Memuat tugas...</li>
        </ul>
    </div>
  </div>

  <div class="card">
    <h3>Jadwal Pelajaran Hari Ini</h3>
    <table class="schedule-table" id="schedule-table">
      <thead>
        <tr>
          <th>Hari</th>
          <th>Jam</th>
          <th>Mapel</th>
          <th>Guru</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="no-schedule" style="margin-top:10px; color:var(--subtext); display:none;">Tidak ada jadwal pelajaran untuk hari ini.</p>
  </div>
</div>

<footer>© 2025 Khalid — Ruang Pribadi.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ======================
// Konstanta Supabase
// ======================
const supabaseUrl = "https://bwfoeapwqdrinqgccxpw.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3Zm9lYXB3cWRyaW5xZ2NjeHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTUzNTYsImV4cCI6MjA3NTM5MTM1Nn0.grJkA6XjIvAOWzmWTMx-Rp8BUVdvwTd_pawNQsM0Vt8";
const supa = supabase.createClient(supabaseUrl, supabaseKey);


// ======================
// Tanggal & Jam
// ======================
function updateDate(){ const date=new Date(); document.getElementById('today').textContent=date.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'});}
function updateGreeting(){ const hour=new Date().getHours(); let g=""; if(hour>=4&&hour<11)g="Selamat Pagi"; else if(hour>=11&&hour<15) g="Selamat Siang"; else if(hour>=15&&hour<18) g="Selamat Sore"; else g="Selamat Malam"; document.getElementById("greeting").textContent=g+", Khalid";}
function updateClock(){ const now=new Date(); let h=now.getHours().toString().padStart(2,'0'), m=now.getMinutes().toString().padStart(2,'0'), s=now.getSeconds().toString().padStart(2,'0'); document.getElementById("clock").textContent=`${h}:${m}:${s} WIB`;}
updateDate(); updateGreeting(); updateClock();
// Memuat jadwal setiap detik untuk update status "active-class"
setInterval(()=>{ updateDate(); updateGreeting(); updateClock(); loadJadwal(); },1000);


// ======================
// FUNGSI UTAMA PENGUBAH STATUS TUGAS
// ======================
async function markTaskAsDone(taskId) {
    const li = document.getElementById(`task-${taskId}`);
    if (li) {
        const btn = li.querySelector('.done-btn');
        btn.textContent = 'Memproses...';
        btn.disabled = true;
    }

    const { error } = await supa
        .from('tugas')
        .update({ is_done: true }) 
        .eq('id', taskId); 

    if (error) {
        console.error("Gagal memperbarui status tugas:", error);
        alert(`Gagal menyelesaikan tugas: ${error.message}.`);
    }

    loadTugas(); 
}


// ======================
// Daftar Tugas dari Supabase (Tabel: public.tugas)
// ======================
const todoList = document.getElementById("todo-list");

async function loadTugas() {
  todoList.innerHTML = "<li>Memuat tugas...</li>";

  const { data, error } = await supa
    .from("tugas") 
    .select("id, judul, tanggal_awal, tanggal_akhir, is_done") 
    .eq('is_done', false) 
    .order('tanggal_awal'); 

  if (error) {
    console.error("Error fetching tasks:", error);
    todoList.innerHTML = `<li style="color:#ff5555;">Gagal memuat daftar tugas: ${error.message}.</li>`;
    return;
  }
  
  renderTugas(data);
}

function renderTugas(tasks) {
  todoList.innerHTML = "";
  const today = new Date();
  today.setHours(0, 0, 0, 0); 
  
  if (!tasks || tasks.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Tidak ada tugas aktif yang belum selesai saat ini.";
    li.style.color = "var(--subtext)";
    todoList.appendChild(li);
  } else {
    tasks.forEach(task => {
      const li = document.createElement("li");
      li.id = `task-${task.id}`; 
      
      const start = task.tanggal_awal ? new Date(task.tanggal_awal) : null;
      const end = task.tanggal_akhir ? new Date(task.tanggal_akhir) : null;
      
      let dueText = '';
      let dateStatusClass = '';

      if (start) {
          const startDateString = start.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
          dueText += `Mulai: ${startDateString}`;
      }
      
      if (end) {
          const endDateString = end.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
          dueText += (dueText ? ' | ' : '') + `Batas Waktu: ${endDateString}`;

          if (end < today && task.is_done !== true) {
              dateStatusClass = 'overdue';
          }
      } else {
           dueText += (dueText ? ' | ' : '') + `Batas Waktu: Tidak Ditentukan`;
      }
      
      li.innerHTML = `
          <div class="task-details">
              <span class="task-title">${task.judul || "Tugas Tanpa Judul"}</span>
              <span class="task-due ${dateStatusClass}">${dueText || 'Tanggal tidak tersedia'}</span>
          </div>
          <button class="done-btn" onclick="markTaskAsDone(${task.id})">Selesai</button>
      `;
      
      todoList.appendChild(li);
    });
  }
}


// ======================
// Jadwal Pelajaran (Tampilkan berdasarkan Hari Ini)
// ======================
const tbody = document.querySelector("#schedule-table tbody");
let jadwalData=[];

async function loadJadwal(){
  const {data,error} = await supa.from("jadwal_pelajaran").select("*").order('id');
  if(error){ console.error(error); return; }
  jadwalData = data;
  renderTable();
}

function renderTable(){
  tbody.innerHTML = "";
  const now = new Date();
  const nowMinutes = now.getHours()*60 + now.getMinutes();
  const todayName = now.toLocaleDateString('id-ID',{weekday:'long'}); 
  let hasSchedule = false;

  // 1. Filter jadwal hanya untuk hari ini
  const scheduleForToday = jadwalData.filter(item => item.hari === todayName);

  if (scheduleForToday && scheduleForToday.length > 0) {
      hasSchedule = true;
      
      // 2. Tambahkan Baris Header Hari Ini
      const headerTr = document.createElement('tr');
      headerTr.innerHTML = `<th colspan="4" style="text-align: center; background: var(--accent2); color: var(--bg-card); padding: 8px;">${todayName.toUpperCase()}</th>`;
      tbody.appendChild(headerTr);

      // 3. Urutkan mata pelajaran hari ini berdasarkan jam mulai
      scheduleForToday.sort((a, b) => {
          const startTimeA = parseInt(a.jam.split('–')[0].trim().replace(':', ''));
          const startTimeB = parseInt(b.jam.split('–')[0].trim().replace(':', ''));
          return startTimeA - startTimeB;
      });

      // 4. Tambahkan Baris Mata Pelajaran
      scheduleForToday.forEach(item => {
        let rowClass = '';
        
        // Cek apakah mata pelajaran sedang aktif saat ini
        if(item.jam && item.jam.includes('–')){
            const [start, end] = item.jam.split('–').map(t=>t.trim());
            const startParts = start.split(':');
            const endParts   = end.split(':');

            if(startParts.length===2 && endParts.length===2){
                const startMinutes = parseInt(startParts[0])*60 + parseInt(startParts[1]);
                const endMinutes   = parseInt(endParts[0])*60 + parseInt(endParts[1]);

                // Gunakan < endMinutes agar tidak bentrok dengan awal kelas berikutnya
                if(nowMinutes >= startMinutes && nowMinutes < endMinutes){ 
                    rowClass = 'active-class'; 
                }
            }
        }
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${item.hari || "-"}</td> 
          <td>${item.jam || "-"}</td>
          <td>${item.mapel || "-"}</td>
          <td>${item.guru || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // Tampilkan/sembunyikan pesan "Tidak ada jadwal"
  document.getElementById('no-schedule').style.display = hasSchedule ? "none" : "block";
  document.getElementById('schedule-table').style.display = hasSchedule ? 'table' : 'none';
}

// ======================
// Load Data Awal
// ======================
loadJadwal();
loadTugas(); 
</script>
</body>
</html>
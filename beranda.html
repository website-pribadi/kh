<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link rel="icon" href="ikon2.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #070a13; /* Lebih gelap, mendekati hitam */
  --bg-card: #121626; /* Lebih soft dari sebelumnya */
  --accent: #00ffc3; /* Neon Cyan */
  --accent2: #7a5cff; /* Neon Purple */
  --text: #f0f0f0; /* Lebih terang */
  --subtext: #a0a0a0;
  --border: rgba(255,255,255,0.08);
  --shadow-glow: 0 0 15px rgba(0,255,195,0.2);
}
* { box-sizing:border-box; margin:0; padding:0; }
body {
  min-height:100vh; 
  font-family:'Poppins',sans-serif;
  /* Gradien yang lebih dalam */
  background:linear-gradient(145deg, #04060c 0%, #0c1221 100%); 
  color:var(--text);
  display:flex; 
  align-items:center; 
  justify-content:center;
  text-align:center; 
  flex-direction:column; 
  overflow-x:hidden; 
  padding-bottom: 60px; 
}
@keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
@keyframes pulseGlow { 0% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 15px var(--accent), 0 0 25px rgba(0,255,195,0.4); } 100% { box-shadow: 0 0 5px var(--accent); } }

/* Header Info */
.header-container {
    width: 100%;
    max-width: 1200px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: absolute;
    top: 0;
    z-index: 10;
}
.time-info { 
    text-align:left; 
    line-height:1.3; 
    animation:fadeIn 1.2s ease; 
}
.time-info h1{ 
    font-size:2.2em; 
    color:var(--accent); 
    margin-bottom:4px; 
    font-weight:700;
    /* Glow yang lebih halus tapi terasa */
    text-shadow:0 0 10px rgba(0,255,195,0.6), 0 0 20px rgba(0,255,195,0.2); 
}
.time-info h2{ 
    font-size:1.1em; 
    color:var(--accent2); 
    font-weight:400;
    text-shadow:0 0 8px rgba(122,92,255,0.4); 
}
.clock { 
    font-size:1.8em; 
    color:var(--accent); 
    text-shadow:0 0 10px rgba(0,255,195,0.5); 
    animation:fadeIn 1.2s ease; 
    font-weight:600; 
    margin-top: 5px;
    letter-spacing: 1px; /* Tambahkan sedikit jarak antar huruf */
}

/* Main Content */
.main { 
    width: 100%;
    max-width: 1200px;
    padding: 20px;
    display: flex; 
    gap: 30px; 
    margin-top: 120px; 
}

/* KONTROL URUTAN PC */
#todo-card { order: 1; }
#schedule-card { order: 2; }

.card { 
    background:var(--bg-card); 
    border:1px solid var(--border); 
    border-radius:18px; 
    padding:30px; 
    /* Shadow 3D yang lebih elegan */
    box-shadow: 0 15px 35px rgba(0,0,0,0.7), inset 0 0 5px rgba(255,255,255,0.05); 
    transition:transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s ease; 
    flex: 1; 
    min-height: 350px; 
    text-align: left; 
    position: relative; 
    display: flex; 
    flex-direction: column;
}
.card:hover { 
    transform:translateY(-8px); 
    box-shadow:0 15px 50px rgba(0,0,0,0.8), 0 0 25px rgba(0,255,195,0.3); 
}
.card h3{ 
    color:var(--accent); 
    margin-bottom:20px; 
    font-size:1.5em; 
    font-weight:700;
    border-bottom: 2px solid rgba(0,255,195,0.5); 
    padding-bottom: 10px;
    letter-spacing: 0.5px;
    flex-shrink: 0; 
}
.card p{ color:var(--subtext); line-height:1.7; white-space:pre-line; }

/* Footer */
footer{ 
    position:fixed; 
    bottom:0; 
    width:100%; 
    padding:10px; 
    font-size:0.85em; 
    color:#777; 
    background:rgba(0,0,0,0.6); 
    backdrop-filter:blur(8px); 
    z-index:10; 
    border-top: 1px solid rgba(255,255,255,0.05);
}

/* ==================================== */
/* JADWAL PELAJARAN (REVISI SCROLLBAR) */
/* ==================================== */
.schedule-wrapper {
    max-height: 400px; 
    overflow-y: auto;
    flex-grow: 1; 
    border: 1px solid var(--border); 
    border-radius: 10px;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
    background: rgba(0,0,0,0.2);
    padding-right: 8px; /* Ruang untuk scrollbar */
}
/* SCROLLBAR STYLING JADWAL */
.schedule-wrapper::-webkit-scrollbar { width: 8px; }
.schedule-wrapper::-webkit-scrollbar-thumb {
    background: var(--accent2); 
    border-radius: 4px;
    transition: background 0.3s;
}
.schedule-wrapper::-webkit-scrollbar-track { background: var(--bg-card); }
.schedule-wrapper::-webkit-scrollbar-thumb:hover { background: #9980ff; }


.schedule-table { 
    width:100%; 
    border-collapse:separate; 
    border-spacing:0; 
    text-align:left; 
    font-size:0.95em; 
    margin-top:0; 
}
.schedule-table thead {
    position: sticky;
    top: 0;
    background: var(--bg-card); 
    z-index: 5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}
.schedule-table th, .schedule-table td{ 
    padding:12px 15px; 
    border:none; 
    transition: background 0.3s, transform 0.3s; 
}
.schedule-table th{ 
    color:var(--accent2); 
    background:rgba(122,92,255,0.15); 
    font-weight:600; 
    border-bottom: 1px solid rgba(122,92,255,0.3);
}
.schedule-table td{ color:var(--text); border-bottom:1px solid var(--border);}
.schedule-table tbody tr:nth-child(even){ background:rgba(255,255,255,0.02);}
.schedule-table tbody tr:hover:not(.active-class){ 
    background:rgba(0,255,195,0.08); 
    transform:translateX(5px); 
}
.active-class {
    background: linear-gradient(90deg, #008f76 0%, #006b5a 100%) !important; 
    border-left: 5px solid var(--accent) !important; 
    box-shadow: 0 0 15px var(--accent) inset, 0 0 10px rgba(0,255,195,0.8); 
    font-weight: bold;
    animation: pulseGlow 3s infinite alternate; 
}
.active-class td {
    color: #fff !important; 
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}


/* ================================== */
/* DAFTAR TUGAS (REVISI SCROLLBAR) */
/* ================================== */
.todo-container { 
    max-height: 400px; 
    overflow-y: auto;
    flex-grow: 1; 
    padding-right: 8px; /* Ruang untuk scrollbar */
}
#todo-list { list-style: none; padding: 0; }

/* SCROLLBAR STYLING TUGAS */
.todo-container::-webkit-scrollbar { width: 8px; } 
.todo-container::-webkit-scrollbar-thumb { 
    background: var(--accent2); 
    border-radius: 4px; 
    transition: background 0.3s;
}
.todo-container::-webkit-scrollbar-track { background: var(--bg-card); }
.todo-container::-webkit-scrollbar-thumb:hover { background: #9980ff; }


#todo-list li {
  padding: 15px 0; 
  border-bottom: 1px solid var(--border);
  display: flex; 
  align-items: center;
  justify-content: space-between;
  transition: background 0.3s;
}
#todo-list li:hover {
    background: rgba(122,92,255,0.05); 
}
#todo-list li:last-child { border-bottom: none; }
#todo-list li .task-details { flex-grow: 1; }
#todo-list li .task-title {
    font-weight: 600;
    color: var(--text);
    display: block;
    font-size: 0.95em; 
}
#todo-list li .task-due {
    font-size: 0.85em; 
    color: var(--subtext);
    display: block;
    margin-top: 5px;
}
#todo-list li .task-due.overdue {
    color: #ff5c5c; 
    font-weight: bold;
    text-shadow: 0 0 5px rgba(255,92,92,0.5);
}
.done-btn {
    background: linear-gradient(135deg, var(--accent), #00e6a3);
    color: var(--bg-dark); 
    padding: 8px 18px; 
    border: none;
    border-radius: 25px; 
    font-size: 0.9em;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.4s ease;
    margin-left: 15px;
    box-shadow: 0 4px 15px rgba(0,255,195,0.4);
}
.done-btn:hover {
    background: linear-gradient(135deg, #00e6a3, var(--accent));
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0,255,195,0.6);
}

/* --- RESPONSIVE (MOBILE) --- */
@media (max-width:768px){
  
  body { padding-bottom: 50px; }
  .header-container { align-items: flex-start; padding: 15px; }
  .time-info{ text-align:left; width: 60%; margin-bottom: 0; }
  .time-info h1{ font-size:1.6em;}
  .time-info h2{ font-size:0.8em;}
  .clock{ 
      position: absolute; 
      right: 15px; 
      top: 15px; 
      font-size:1.3em;
  }
  
  .main{ 
    flex-direction: column; 
    gap: 20px;
    padding: 15px;
    margin-top: 80px; 
  }
  
  /* KONTROL URUTAN MOBILE */
  #todo-card { order: 1; }
  #schedule-card { order: 2; }

  .card{ 
    min-height: auto; 
    box-shadow:0 10px 20px rgba(0,0,0,0.5); 
    padding: 20px;
  }
  .card:hover { transform:none; box-shadow:0 10px 20px rgba(0,0,0,0.5), 0 0 10px rgba(0,255,195,0.2); } 
  .card h3{ font-size:1.3em; margin-bottom: 15px; }

  /* Reset max-height dan scroll di Mobile agar konten memanjang penuh */
  .todo-container, .schedule-wrapper {
    max-height: none;
    overflow-y: visible;
    border: none;
    padding: 0;
    box-shadow: none;
    background: none;
  }
  
  /* Sembunyikan Scrollbar Kustom di Mobile */
  .todo-container::-webkit-scrollbar,
  .schedule-wrapper::-webkit-scrollbar {
    width: 0;
    height: 0;
  }

  .schedule-table thead {
    position: static;
  }
  
  .schedule-table th, .schedule-table td{ 
      padding: 6px 4px; 
      font-size: 0.8em; 
  }

  #todo-list li .task-title {
      font-size: 0.85em; 
  }
  #todo-list li .task-due {
      font-size: 0.75em; 
  }

  .done-btn {
      padding: 5px 10px; 
      font-size: 0.75em;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,255,195,0.3);
  }
}
</style>
</head>
<body>

<div class="header-container">
    <div class="time-info">
      <h1 id="greeting">Selamat Datang, Khalid</h1>
      <h2 id="today">Memuat tanggal...</h2>
    </div>
    <div class="clock" id="clock">00:00:00</div>
</div>

<div class="main">
  <div class="card" id="todo-card"> 
    <h3>Daftar Semua Tugas</h3>
    <div class="todo-container">
        <ul id="todo-list">
            <li>Memuat tugas...</li>
        </ul>
    </div>
  </div>

  <div class="card" id="schedule-card"> 
    <h3>Jadwal Pelajaran Hari Ini</h3>
    
    <div class="schedule-wrapper"> 
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th>Hari</th> <th>Jam</th>
            <th>Mapel</th>
            <th>Guru</th> </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div> 
    
    <p id="no-schedule" style="margin-top:20px; color:var(--subtext); display:none;">Tidak ada jadwal pelajaran untuk hari ini. Waktunya santai!</p>
  </div>
</div>

<footer>© 2025 Khalid — Ruang Pribadi.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ======================
// Konstanta Supabase
// ======================
const supabaseUrl = "https://bwfoeapwqdrinqgccxpw.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3Zm9lYXB3cWRyaW5xZ2NjeHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTUzNTYsImV4cCI6MjA3NTM5MTM1Nn0.grJkA6XjIvAOWzmWTMx-Rp8BUVdvwTd_pawNQsM0Vt8";
const supa = supabase.createClient(supabaseUrl, supabaseKey);


// ======================
// Tanggal & Jam
// ======================
function updateDate(){ const date=new Date(); document.getElementById('today').textContent=date.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'});}
function updateGreeting(){ const hour=new Date().getHours(); let g=""; if(hour>=4&&hour<11)g="Selamat Pagi"; else if(hour>=11&&hour<15) g="Selamat Siang"; else if(hour>=15&&hour<18) g="Selamat Sore"; else g="Selamat Malam"; document.getElementById("greeting").textContent=g+", Khalid";}
function updateClock(){ const now=new Date(); let h=now.getHours().toString().padStart(2,'0'), m=now.getMinutes().toString().padStart(2,'0'), s=now.getSeconds().toString().padStart(2,'0'); document.getElementById("clock").textContent=`${h}:${m}:${s} WIB`;}
updateDate(); updateGreeting(); updateClock();
setInterval(()=>{ updateDate(); updateGreeting(); updateClock(); loadJadwal(); },1000);


// ======================
// FUNGSI UTAMA PENGUBAH STATUS TUGAS
// ======================
async function markTaskAsDone(taskId) {
    const li = document.getElementById(`task-${taskId}`);
    if (li) {
        const btn = li.querySelector('.done-btn');
        btn.textContent = '✅ Done';
        btn.disabled = true;
        li.style.background = 'rgba(0,255,195,0.2)'; 
        li.style.transition = 'all 0.5s ease';
        
        await new Promise(r => setTimeout(r, 500)); 

        li.style.opacity = '0';
        li.style.transform = 'translateX(100%)';
        await new Promise(r => setTimeout(r, 500)); 
    }

    const { error } = await supa
        .from('tugas')
        .update({ is_done: true }) 
        .eq('id', taskId); 

    if (error) {
        console.error("Gagal memperbarui status tugas:", error);
        alert(`Gagal menyelesaikan tugas: ${error.message}.`);
        if (li) {
            li.style.opacity = '1';
            li.style.transform = 'translateX(0)';
            li.style.background = 'none';
            li.querySelector('.done-btn').textContent = 'Selesai';
            li.querySelector('.done-btn').disabled = false;
        }
        return;
    }

    loadTugas(); 
}


// ======================
// Daftar Tugas dari Supabase (Tabel: public.tugas)
// ======================
const todoList = document.getElementById("todo-list");

async function loadTugas() {
  todoList.innerHTML = "<li>Memuat tugas...</li>";

  const { data, error } = await supa
    .from("tugas") 
    .select("id, judul, tanggal_awal, tanggal_akhir, is_done") 
    .eq('is_done', false) 
    .order('tanggal_akhir', { ascending: true }) 
    .order('tanggal_awal'); 

  if (error) {
    console.error("Error fetching tasks:", error);
    todoList.innerHTML = `<li style="color:#ff5c5c;">Gagal memuat daftar tugas: ${error.message}.</li>`;
    return;
  }
  
  renderTugas(data);
}

function renderTugas(tasks) {
  todoList.innerHTML = "";
  const today = new Date();
  today.setHours(0, 0, 0, 0); 
  
  if (!tasks || tasks.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Tidak ada tugas aktif yang belum selesai saat ini. Kerja bagus!";
    li.style.color = "var(--subtext)";
    todoList.appendChild(li);
  } else {
    tasks.forEach(task => {
      const li = document.createElement("li");
      li.id = `task-${task.id}`; 
      
      const start = task.tanggal_awal ? new Date(task.tanggal_awal) : null;
      const end = task.tanggal_akhir ? new Date(task.tanggal_akhir) : null;
      
      let dueText = '';
      let dateStatusClass = '';

      // Tentukan Batas Waktu
      if (end) {
          const endDateString = end.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
          
          dueText = `Batas Waktu: ${endDateString}`;
          if (end < today && task.is_done !== true) {
              dateStatusClass = 'overdue'; 
          }
      } else {
           dueText = `Batas Waktu: Tidak Ditentukan`;
      }

      // Tentukan Tanggal Mulai (Optional)
      if (start && end && start.getTime() !== end.getTime()) {
          const startDateString = start.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
          dueText = `Mulai: ${startDateString} | ${dueText}`;
      } else if (start && !end) {
          const startDateString = start.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
          dueText = `Mulai: ${startDateString}`;
      }
      
      li.innerHTML = `
          <div class="task-details">
              <span class="task-title">${task.judul || "Tugas Tanpa Judul"}</span>
              <span class="task-due ${dateStatusClass}">${dueText || 'Tanggal tidak tersedia'}</span>
          </div>
          <button class="done-btn" onclick="markTaskAsDone(${task.id})">Selesai</button>
      `;
      
      todoList.appendChild(li);
    });
  }
}


// ======================
// Jadwal Pelajaran (Tampilkan berdasarkan Hari Ini)
// ======================
const tbody = document.querySelector("#schedule-table tbody");
let jadwalData=[];

async function loadJadwal(){
  const {data,error} = await supa.from("jadwal_pelajaran").select("*").order('id');
  if(error){ console.error(error); return; }
  jadwalData = data;
  renderTable();
}

function renderTable(){
  tbody.innerHTML = "";
  const now = new Date();
  const nowMinutes = now.getHours()*60 + now.getMinutes();
  const todayName = now.toLocaleDateString('id-ID',{weekday:'long'}); 
  let hasSchedule = false;

  // 1. Filter jadwal hanya untuk hari ini
  const scheduleForToday = jadwalData.filter(item => item.hari === todayName);

  if (scheduleForToday && scheduleForToday.length > 0) {
      hasSchedule = true;
      
      // 2. Urutkan mata pelajaran hari ini berdasarkan jam mulai
      scheduleForToday.sort((a, b) => {
          // Fungsi untuk mengubah format jam "HH:MM" menjadi menit total
          const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(Number);
            return parts.length === 2 ? parts[0] * 60 + parts[1] : 0;
          };
          
          const startA = a.jam.split('–')[0].trim();
          const startB = b.jam.split('–')[0].trim();
          return timeToMinutes(startA) - timeToMinutes(startB);
      });

      // 3. Tambahkan Baris Mata Pelajaran
      scheduleForToday.forEach(item => {
        let rowClass = '';
        
        // Cek apakah mata pelajaran sedang aktif saat ini
        if(item.jam && item.jam.includes('–')){
            const [start, end] = item.jam.split('–').map(t=>t.trim());
            const startParts = start.split(':');
            const endParts   = end.split(':');

            if(startParts.length===2 && endParts.length===2){
                const startMinutes = parseInt(startParts[0])*60 + parseInt(startParts[1]);
                const endMinutes   = parseInt(endParts[0])*60 + parseInt(endParts[1]);

                if(nowMinutes >= startMinutes && nowMinutes < endMinutes){ 
                    rowClass = 'active-class'; 
                }
            }
        }
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${item.hari || "-"}</td> 
          <td>${item.jam || "-"}</td>
          <td>${item.mapel || "-"}</td>
          <td>${item.guru || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // Tampilkan/sembunyikan pesan "Tidak ada jadwal"
  document.getElementById('no-schedule').style.display = hasSchedule ? "none" : "block";
  document.getElementById('schedule-table').style.display = hasSchedule ? 'table' : 'none';
}

// ======================
// Load Data Awal
// ======================
loadJadwal();
loadTugas(); 
</script>
</body>
</html>
